{"version":3,"sources":["../../../plugins/sequence/src/BgzipFastaAdapter/BgzipFastaAdapter.ts","../../../node_modules/@gmod/indexedfasta/esm/indexedFasta.js","../../../node_modules/@gmod/indexedfasta/esm/index.js","../../../node_modules/@gmod/indexedfasta/esm/bgzipIndexedFasta.js","../../../plugins/sequence/src/IndexedFastaAdapter/IndexedFastaAdapter.ts"],"names":["config","getSubAdapter","pluginManager","fastaLocation","readConfObject","faiLocation","gziLocation","Error","fastaOpts","fasta","openLocation","fai","gzi","BgzipIndexedFasta","IndexedFasta","Object","defineProperty","exports","value","generic_filehandle_1","require","_faiOffset","idx","pos","offset","lineBytes","Math","floor","lineLength","readFAI","opts","readFile","text","length","idCounter","data","toString","split","filter","line","test","map","row","currSeq","name","id","start","end","fromEntries","entry","path","faiPath","chunkSizeLimit","this","LocalFile","indexes","_getIndexes","keys","returnObject","vals","values","i","seqName","_a","seqId","min","max","indexEntry","undefined","_fetchFromIndexEntry","getResiduesByName","TypeError","position","readlen","toLocaleString","residues","Buffer","allocUnsafe","read","replace","default","__importDefault","mod","__esModule","FetchableSmallFasta","parseSmallFasta","object_fromentries_1","bgzipIndexedFasta_1","indexedFasta_1","t","entryText","defLine","seqLines","description","sequence","join","shim","then","buffer","find","iter","substr","bgzf_filehandle_1","gziPath","BgzfFilehandle","filehandle","gziFilehandle","seqCache","AbortablePromiseCache","cache","LRU","maxSize","fill","args","signal","a","refName","getSequence","getSequenceNames","getSequenceSizes","seqSizes","region","ObservableCreate","observer","getSequenceSize","size","regionEnd","chunks","e","chunkSize","chunkStart","s","r","push","get","JSON","stringify","Promise","all","seq","slice","next","SimpleFeature","complete","BaseSequenceAdapter"],"mappings":"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","file":"static/js/22.74bf70b8.chunk.js","sourcesContent":["import { BgzipIndexedFasta } from '@gmod/indexedfasta'\nimport { FileLocation } from '@jbrowse/core/util/types'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { readConfObject } from '@jbrowse/core/configuration'\nimport { AnyConfigurationModel } from '@jbrowse/core/configuration/configurationSchema'\nimport IndexedFasta from '../IndexedFastaAdapter/IndexedFastaAdapter'\nimport PluginManager from '@jbrowse/core/PluginManager'\nimport { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\n\nexport default class extends IndexedFasta {\n  public constructor(\n    config: AnyConfigurationModel,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    const fastaLocation = readConfObject(config, 'fastaLocation')\n    const faiLocation = readConfObject(config, 'faiLocation')\n    const gziLocation = readConfObject(config, 'gziLocation')\n    if (!fastaLocation) {\n      throw new Error('must provide fastaLocation')\n    }\n    if (!faiLocation) {\n      throw new Error('must provide faiLocation')\n    }\n    if (!gziLocation) {\n      throw new Error('must provide gziLocation')\n    }\n    const fastaOpts = {\n      fasta: openLocation(fastaLocation as FileLocation, this.pluginManager),\n      fai: openLocation(faiLocation as FileLocation, this.pluginManager),\n      gzi: openLocation(gziLocation as FileLocation, this.pluginManager),\n    }\n\n    this.fasta = new BgzipIndexedFasta(fastaOpts)\n  }\n}\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst generic_filehandle_1 = require(\"generic-filehandle\");\nfunction _faiOffset(idx, pos) {\n    return (idx.offset +\n        idx.lineBytes * Math.floor(pos / idx.lineLength) +\n        (pos % idx.lineLength));\n}\nasync function readFAI(fai, opts) {\n    const text = await fai.readFile(opts);\n    if (!(text && text.length)) {\n        throw new Error('No data read from FASTA index (FAI) file');\n    }\n    let idCounter = 0;\n    let currSeq;\n    const data = text\n        .toString('utf8')\n        .split(/\\r?\\n/)\n        .filter(line => /\\S/.test(line))\n        .map(line => line.split('\\t'))\n        .filter(row => row[0] !== '')\n        .map(row => {\n        if (!currSeq || currSeq.name !== row[0]) {\n            currSeq = { name: row[0], id: idCounter };\n            idCounter += 1;\n        }\n        return {\n            id: currSeq.id,\n            name: row[0],\n            length: +row[1],\n            start: 0,\n            end: +row[1],\n            offset: +row[2],\n            lineLength: +row[3],\n            lineBytes: +row[4],\n        };\n    });\n    return {\n        name: Object.fromEntries(data.map(entry => [entry.name, entry])),\n        id: Object.fromEntries(data.map(entry => [entry.id, entry])),\n    };\n}\nclass IndexedFasta {\n    constructor({ fasta, fai, path, faiPath, chunkSizeLimit = 1000000, }) {\n        if (fasta) {\n            this.fasta = fasta;\n        }\n        else if (path) {\n            this.fasta = new generic_filehandle_1.LocalFile(path);\n        }\n        else {\n            throw new Error('Need to pass filehandle for fasta or path to localfile');\n        }\n        if (fai) {\n            this.fai = fai;\n        }\n        else if (faiPath) {\n            this.fai = new generic_filehandle_1.LocalFile(faiPath);\n        }\n        else if (path) {\n            this.fai = new generic_filehandle_1.LocalFile(`${path}.fai`);\n        }\n        else {\n            throw new Error('Need to pass filehandle for  or path to localfile');\n        }\n        this.chunkSizeLimit = chunkSizeLimit;\n    }\n    async _getIndexes(opts) {\n        if (!this.indexes) {\n            this.indexes = readFAI(this.fai, opts);\n        }\n        return this.indexes;\n    }\n    /**\n     * @returns {array[string]} array of string sequence\n     * names that are present in the index, in which the\n     * array index indicates the sequence ID, and the value\n     * is the sequence name\n     */\n    async getSequenceNames(opts) {\n        return Object.keys((await this._getIndexes(opts)).name);\n    }\n    /**\n     * @returns {array[string]} array of string sequence\n     * names that are present in the index, in which the\n     * array index indicates the sequence ID, and the value\n     * is the sequence name\n     */\n    async getSequenceSizes(opts) {\n        const returnObject = {};\n        const idx = await this._getIndexes(opts);\n        const vals = Object.values(idx.id);\n        for (let i = 0; i < vals.length; i += 1) {\n            returnObject[vals[i].name] = vals[i].length;\n        }\n        return returnObject;\n    }\n    /**\n     * @returns {array[string]} array of string sequence\n     * names that are present in the index, in which the\n     * array index indicates the sequence ID, and the value\n     * is the sequence name\n     */\n    async getSequenceSize(seqName, opts) {\n        var _a;\n        const idx = await this._getIndexes(opts);\n        return (_a = idx.name[seqName]) === null || _a === void 0 ? void 0 : _a.length;\n    }\n    /**\n     *\n     * @param {string} name\n     * @returns {Promise[boolean]} true if the file contains the given reference sequence name\n     */\n    async hasReferenceSequence(name, opts) {\n        return !!(await this._getIndexes(opts)).name[name];\n    }\n    /**\n     *\n     * @param {number} seqId\n     * @param {number} min\n     * @param {number} max\n     */\n    async getResiduesById(seqId, min, max, opts) {\n        const indexEntry = (await this._getIndexes(opts)).id[seqId];\n        if (!indexEntry) {\n            return undefined;\n        }\n        return this._fetchFromIndexEntry(indexEntry, min, max, opts);\n    }\n    /**\n     * @param {string} seqName\n     * @param {number} min\n     * @param {number} max\n     */\n    async getResiduesByName(seqName, min, max, opts) {\n        const indexEntry = (await this._getIndexes(opts)).name[seqName];\n        if (!indexEntry) {\n            return undefined;\n        }\n        return this._fetchFromIndexEntry(indexEntry, min, max, opts);\n    }\n    //alias for getResiduesByName\n    async getSequence(seqName, min, max, opts) {\n        return this.getResiduesByName(seqName, min, max, opts);\n    }\n    async _fetchFromIndexEntry(indexEntry, min = 0, max, opts) {\n        let end = max;\n        if (min < 0) {\n            throw new TypeError('regionStart cannot be less than 0');\n        }\n        if (end === undefined || end > indexEntry.length) {\n            end = indexEntry.length;\n        }\n        if (min >= end) {\n            return '';\n        }\n        const position = _faiOffset(indexEntry, min);\n        const readlen = _faiOffset(indexEntry, end) - position;\n        if (readlen > this.chunkSizeLimit) {\n            throw new Error(`data size of ${readlen.toLocaleString()} bytes exceeded chunk size limit of ${this.chunkSizeLimit.toLocaleString()} bytes`);\n        }\n        const residues = Buffer.allocUnsafe(readlen);\n        await this.fasta.read(residues, 0, readlen, position, opts);\n        return residues.toString('utf8').replace(/\\s+/g, '');\n    }\n}\nexports.default = IndexedFasta;\n","\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.BgzipIndexedFasta = exports.IndexedFasta = exports.FetchableSmallFasta = exports.parseSmallFasta = void 0;\nconst object_fromentries_1 = __importDefault(require(\"object.fromentries\"));\nconst generic_filehandle_1 = require(\"generic-filehandle\");\nconst bgzipIndexedFasta_1 = __importDefault(require(\"./bgzipIndexedFasta\"));\nexports.BgzipIndexedFasta = bgzipIndexedFasta_1.default;\nconst indexedFasta_1 = __importDefault(require(\"./indexedFasta\"));\nexports.IndexedFasta = indexedFasta_1.default;\nif (!Object.fromEntries) {\n    // @ts-ignore\n    object_fromentries_1.default.shim();\n}\nfunction parseSmallFasta(text) {\n    return text\n        .split('>')\n        .filter(t => /\\S/.test(t))\n        .map(entryText => {\n        const [defLine, ...seqLines] = entryText.split('\\n');\n        const [id, ...description] = defLine.split(' ');\n        const sequence = seqLines.join('').replace(/\\s/g, '');\n        return {\n            id,\n            description: description.join(' '),\n            sequence,\n        };\n    });\n}\nexports.parseSmallFasta = parseSmallFasta;\n// memoized\nclass FetchableSmallFasta {\n    constructor({ fasta, path }) {\n        if (fasta) {\n            this.fasta = fasta;\n        }\n        else if (path) {\n            this.fasta = new generic_filehandle_1.LocalFile(path);\n        }\n        else {\n            throw new Error('Need to pass fasta or path');\n        }\n        this.data = this.fasta.readFile().then(buffer => {\n            const text = buffer.toString('utf8');\n            return parseSmallFasta(text);\n        });\n    }\n    async fetch(id, start, end) {\n        const data = await this.data;\n        const entry = data.find(iter => iter.id === id);\n        const length = end - start;\n        if (!entry) {\n            throw new Error(`no sequence with id ${id} exists`);\n        }\n        return entry.sequence.substr(start, length);\n    }\n    async getSequenceNames() {\n        const data = await this.data;\n        return data.map(entry => entry.id);\n    }\n}\nexports.FetchableSmallFasta = FetchableSmallFasta;\n","\"use strict\";\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst bgzf_filehandle_1 = require(\"@gmod/bgzf-filehandle\");\nconst indexedFasta_1 = __importDefault(require(\"./indexedFasta\"));\nclass BgzipIndexedFasta extends indexedFasta_1.default {\n    constructor({ fasta, path, fai, faiPath, gzi, gziPath, chunkSizeLimit, }) {\n        super({ fasta, path, fai, faiPath, chunkSizeLimit });\n        if (fasta && gzi) {\n            this.fasta = new bgzf_filehandle_1.BgzfFilehandle({\n                filehandle: fasta,\n                gziFilehandle: gzi,\n            });\n        }\n        else if (path && gziPath) {\n            this.fasta = new bgzf_filehandle_1.BgzfFilehandle({ path, gziPath });\n        }\n    }\n}\nexports.default = BgzipIndexedFasta;\n","import { IndexedFasta } from '@gmod/indexedfasta'\nimport {\n  BaseSequenceAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { FileLocation, NoAssemblyRegion } from '@jbrowse/core/util/types'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport SimpleFeature, { Feature } from '@jbrowse/core/util/simpleFeature'\nimport { readConfObject } from '@jbrowse/core/configuration'\nimport { AnyConfigurationModel } from '@jbrowse/core/configuration/configurationSchema'\nimport AbortablePromiseCache from 'abortable-promise-cache'\nimport LRU from '@jbrowse/core/util/QuickLRU'\nimport PluginManager from '@jbrowse/core/PluginManager'\nimport { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\n\nexport default class extends BaseSequenceAdapter {\n  protected fasta: IndexedFasta\n\n  private seqCache = new AbortablePromiseCache({\n    cache: new LRU({ maxSize: 200 }),\n    fill: async (\n      args: { refName: string; start: number; end: number },\n      signal?: AbortSignal,\n    ) => {\n      const { refName, start, end } = args\n      return this.fasta.getSequence(refName, start, end, { ...args, signal })\n    },\n  })\n\n  public constructor(\n    config: AnyConfigurationModel,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    const fastaLocation = readConfObject(config, 'fastaLocation')\n    const faiLocation = readConfObject(config, 'faiLocation')\n    const fastaOpts = {\n      fasta: openLocation(fastaLocation as FileLocation, this.pluginManager),\n      fai: openLocation(faiLocation as FileLocation, this.pluginManager),\n    }\n\n    this.fasta = new IndexedFasta(fastaOpts)\n  }\n\n  public getRefNames(opts?: BaseOptions) {\n    return this.fasta.getSequenceNames(opts)\n  }\n\n  public async getRegions(opts?: BaseOptions) {\n    const seqSizes = await this.fasta.getSequenceSizes(opts)\n    return Object.keys(seqSizes).map(refName => ({\n      refName,\n      start: 0,\n      end: seqSizes[refName],\n    }))\n  }\n\n  /**\n   * Fetch features for a certain region\n   * @param param -\n   * @returns Observable of Feature objects in the region\n   */\n  public getFeatures(region: NoAssemblyRegion, opts?: BaseOptions) {\n    const { refName, start, end } = region\n    return ObservableCreate<Feature>(async observer => {\n      const size = await this.fasta.getSequenceSize(refName, opts)\n      const regionEnd = size !== undefined ? Math.min(size, end) : end\n      const chunks = []\n      const chunkSize = 128000\n\n      const s = start - (start % chunkSize)\n      const e = end + (chunkSize - (end % chunkSize))\n      for (let chunkStart = s; chunkStart < e; chunkStart += chunkSize) {\n        const r = {\n          refName,\n          start: chunkStart,\n          end: chunkStart + chunkSize,\n        }\n        chunks.push(this.seqCache.get(JSON.stringify(r), r, opts?.signal))\n      }\n      const seq = (await Promise.all(chunks))\n        .join('')\n        .slice(start - s)\n        .slice(0, end - start)\n      if (seq) {\n        observer.next(\n          new SimpleFeature({\n            id: `${refName} ${start}-${regionEnd}`,\n            data: { refName, start, end: regionEnd, seq },\n          }),\n        )\n      }\n      observer.complete()\n    })\n  }\n\n  /**\n   * called to provide a hint that data tied to a certain region\n   * will not be needed for the forseeable future and can be purged\n   * from caches, etc\n   */\n  public freeResources(/* { region } */): void {}\n}\n"],"sourceRoot":""}