{"version":3,"sources":["../../../plugins/hic/src/HicAdapter/HicAdapter.ts"],"names":["GenericFilehandleWrapper","filehandle","position","length","a","this","read","Buffer","allocUnsafe","b","buffer","bytesRead","slice","byteOffset","openFilehandleWrapper","location","openLocation","HicAdapter","config","getSubAdapter","pluginManager","hic","hicLocation","readConfObject","HicStraw","file","opts","statusCallback","getMetaData","result","setup","ret","chromosomes","rest","metadata","map","chr","name","bpPerPx","resolutions","chosenResolution","i","r","region","ObservableCreate","observer","refName","start","end","resolution","getResolution","res","getContactRecords","forEach","record","next","complete","signal","_regions","featureDensity","BaseFeatureDataAdapter"],"mappings":"0WA2CMA,E,WACJ,WAAoBC,GAA+B,yBAA/BA,a,+EAEpB,WAAWC,EAAkBC,GAA7B,mBAAAC,EAAA,sEACyCC,KAAKJ,WAAWK,KACrDC,EAAOC,YAAYL,GACnB,EACAA,EACAD,GALJ,uBACkBO,EADlB,EACUC,OAAWC,EADrB,EACqBA,UADrB,kBAQSF,EAAEC,OAAOE,MAAMH,EAAEI,WAAYJ,EAAEI,WAAaF,IARrD,gD,gEAWK,SAASG,EAAsBC,GACpC,OAAO,IAAIf,EAAyBgB,uBAAaD,I,IAG9BE,E,kDAYnB,WACEC,EACAC,EACAC,GACA,2BACA,cAAMF,EAAQC,EAAeC,IAhBvBC,SAeN,EAEA,IAAMC,EAAcC,yBAAeL,EAAQ,eAF3C,OAGA,EAAKG,IAAM,IAAIG,IAAS,CACtBC,KAAMX,EAAsBQ,KAJ9B,E,gFAQF,WAAoBI,GAApB,qFACwCA,GAAQ,IAAtCC,uBADV,MAC2B,aAD3B,GAEiB,2BAFjB,SAGuBtB,KAAKgB,IAAIO,cAHhC,cAGQC,EAHR,OAIEF,EAAe,IAJjB,kBAKSE,GALT,gD,qHAQA,WAAuBH,GAAvB,yFACoBrB,KAAKyB,MAAMJ,GAD/B,cACQK,EADR,OAEmCA,EAAzBC,YAAgBC,EAF1B,YAEmCF,EAFnC,qBAGSE,GAHT,gD,uHAMA,WAAkBP,GAAlB,eAAAtB,EAAA,sEACyBC,KAAKyB,MAAMJ,GADpC,cACQQ,EADR,yBAESA,EAASF,YAAYG,KAAI,SAAAC,GAAG,OAAIA,EAAIC,SAF7C,gD,yHAKA,WAAoBC,EAAiBZ,GAArC,uBAAAtB,EAAA,sEACyBC,KAAKyB,MAAMJ,GADpC,OAKE,IAJMQ,EADR,OAEUK,EAAgBL,EAAhBK,YACJC,EAAmBD,EAAYA,EAAYpC,OAAS,GAE/CsC,EAAIF,EAAYpC,OAAS,EAAGsC,GAAK,EAAGA,GAAK,GAC1CC,EAAIH,EAAYE,KACb,EAAIH,IACXE,EAAmBE,GARzB,yBAWSF,GAXT,gD,kFAcA,SAAYG,GAAuC,WAAvBjB,EAAuB,uDAAJ,GAC7C,OAAOkB,2BAAgB,uCAAgB,WAAMC,GAAN,+BAAAzC,EAAA,6DACpBgC,EAAoBO,EAA7BG,QAAcC,EAAeJ,EAAfI,MAAOC,EAAQL,EAARK,IACrBC,EAAuDvB,EAAvDuB,WAF6B,EAE0BvB,EAA3CY,eAFiB,MAEP,EAFO,IAE0BZ,EAA9BC,sBAFI,MAEa,aAFb,WAGnB,EAAKuB,cAAcZ,GAAWW,GAAc,KAAOvB,GAHhC,cAG/ByB,EAH+B,OAIrCxB,EAAe,yBAJsB,SAMf,EAAKN,IAAI+B,kBAC7B,KACA,CAAEL,QAAOX,MAAKY,OACd,CAAED,QAAOX,MAAKY,OACd,KACAG,GAXmC,cAa7BE,SAAQ,SAAAC,GACdT,EAASU,KAAKD,MAEhB3B,EAAe,IACfkB,EAASW,WAjB4B,4CAAhB,sDAkBpB9B,EAAK+B,U,yEAIV,WAA2BC,GAA3B,SAAAtD,EAAA,+EACS,CAAEuD,eAAgB,IAD3B,2C,kFAIA,gB,GApFsCC,2B","file":"static/js/69.dff80598.chunk.js","sourcesContent":["import {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { Region, FileLocation } from '@jbrowse/core/util/types'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { Instance } from 'mobx-state-tree'\nimport { readConfObject } from '@jbrowse/core/configuration'\nimport type { GenericFilehandle } from 'generic-filehandle'\nimport HicStraw from 'hic-straw'\nimport MyConfigSchema from './configSchema'\nimport PluginManager from '@jbrowse/core/PluginManager'\nimport { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\n\ninterface ContactRecord {\n  bin1: number\n  bin2: number\n  counts: number\n}\n\ninterface HicMetadata {\n  chromosomes: {\n    name: string\n    length: number\n    id: number\n  }[]\n  resolutions: number[]\n}\ninterface Ref {\n  chr: string\n  start: number\n  end: number\n}\n\ninterface HicOptions extends BaseOptions {\n  resolution?: number\n  bpPerPx?: number\n}\n\n// wraps generic-filehandle so the read function only takes a position and length\n// in some ways, generic-filehandle wishes it was just this but it has\n// to adapt to the node.js fs promises API\nclass GenericFilehandleWrapper {\n  constructor(private filehandle: GenericFilehandle) {}\n\n  async read(position: number, length: number) {\n    const { buffer: b, bytesRead } = await this.filehandle.read(\n      Buffer.allocUnsafe(length),\n      0,\n      length,\n      position,\n    )\n    // xref https://stackoverflow.com/a/31394257/2129219\n    return b.buffer.slice(b.byteOffset, b.byteOffset + bytesRead)\n  }\n}\nexport function openFilehandleWrapper(location: FileLocation) {\n  return new GenericFilehandleWrapper(openLocation(location))\n}\n\nexport default class HicAdapter extends BaseFeatureDataAdapter {\n  private hic: {\n    getContactRecords: (\n      normalize: string,\n      ref: Ref,\n      ref2: Ref,\n      units: string,\n      binsize: number,\n    ) => Promise<ContactRecord[]>\n    getMetaData: () => Promise<HicMetadata>\n  }\n\n  public constructor(\n    config: Instance<typeof MyConfigSchema>,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    const hicLocation = readConfObject(config, 'hicLocation')\n    this.hic = new HicStraw({\n      file: openFilehandleWrapper(hicLocation),\n    })\n  }\n\n  private async setup(opts?: BaseOptions) {\n    const { statusCallback = () => {} } = opts || {}\n    statusCallback('Downloading .hic header')\n    const result = await this.hic.getMetaData()\n    statusCallback('')\n    return result\n  }\n\n  public async getHeader(opts?: BaseOptions) {\n    const ret = await this.setup(opts)\n    const { chromosomes, ...rest } = ret\n    return rest\n  }\n\n  async getRefNames(opts?: BaseOptions) {\n    const metadata = await this.setup(opts)\n    return metadata.chromosomes.map(chr => chr.name)\n  }\n\n  async getResolution(bpPerPx: number, opts?: BaseOptions) {\n    const metadata = await this.setup(opts)\n    const { resolutions } = metadata\n    let chosenResolution = resolutions[resolutions.length - 1]\n\n    for (let i = resolutions.length - 1; i >= 0; i -= 1) {\n      const r = resolutions[i]\n      if (r <= 2 * bpPerPx) {\n        chosenResolution = r\n      }\n    }\n    return chosenResolution\n  }\n\n  getFeatures(region: Region, opts: HicOptions = {}) {\n    return ObservableCreate<ContactRecord>(async observer => {\n      const { refName: chr, start, end } = region\n      const { resolution, bpPerPx = 1, statusCallback = () => {} } = opts\n      const res = await this.getResolution(bpPerPx / (resolution || 1000), opts)\n      statusCallback('Downloading .hic data')\n\n      const records = await this.hic.getContactRecords(\n        'KR',\n        { start, chr, end },\n        { start, chr, end },\n        'BP',\n        res,\n      )\n      records.forEach(record => {\n        observer.next(record)\n      })\n      statusCallback('')\n      observer.complete()\n    }, opts.signal) as any // eslint-disable-line @typescript-eslint/no-explicit-any\n  }\n\n  // don't do feature stats estimation, similar to bigwigadapter\n  async estimateRegionsStats(_regions: Region[]) {\n    return { featureDensity: 0 }\n  }\n\n  freeResources(/* { region } */): void {}\n}\n"],"sourceRoot":""}