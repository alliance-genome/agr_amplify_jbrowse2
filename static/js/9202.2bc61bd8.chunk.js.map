{"version":3,"file":"static/js/9202.2bc61bd8.chunk.js","mappings":"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","sources":["../../../packages/core/util/QuickLRU.js","../../../plugins/sequence/src/IndexedFastaAdapter/IndexedFastaAdapter.ts"],"sourcesContent":["/* eslint-disable no-underscore-dangle */\n/**\n * Heavily based on [quick-lru](https://www.npmjs.com/package/quick-lru)\n * (quick-lru didn't work for us because the export wouldn't compile in Webpack\n * properly)\n */\nclass QuickLRU {\n  constructor(options = {}) {\n    if (!(options.maxSize && options.maxSize > 0)) {\n      throw new TypeError('`maxSize` must be a number greater than 0')\n    }\n\n    this.maxSize = options.maxSize\n    this.cache = new Map()\n    this.oldCache = new Map()\n    this._size = 0\n  }\n\n  _set(key, value) {\n    this.cache.set(key, value)\n    this._size += 1\n\n    if (this._size >= this.maxSize) {\n      this._size = 0\n      this.oldCache = this.cache\n      this.cache = new Map()\n    }\n  }\n\n  get(key) {\n    if (this.cache.has(key)) {\n      return this.cache.get(key)\n    }\n\n    if (this.oldCache.has(key)) {\n      const value = this.oldCache.get(key)\n      this.oldCache.delete(key)\n      this._set(key, value)\n      return value\n    }\n\n    return undefined\n  }\n\n  set(key, value) {\n    if (this.cache.has(key)) {\n      this.cache.set(key, value)\n    } else {\n      this._set(key, value)\n    }\n\n    return this\n  }\n\n  has(key) {\n    return this.cache.has(key) || this.oldCache.has(key)\n  }\n\n  peek(key) {\n    if (this.cache.has(key)) {\n      return this.cache.get(key)\n    }\n\n    if (this.oldCache.has(key)) {\n      return this.oldCache.get(key)\n    }\n\n    return undefined\n  }\n\n  delete(key) {\n    const deleted = this.cache.delete(key)\n    if (deleted) {\n      this._size -= 1\n    }\n\n    return this.oldCache.delete(key) || deleted\n  }\n\n  clear() {\n    this.cache.clear()\n    this.oldCache.clear()\n    this._size = 0\n  }\n\n  *keys() {\n    for (const [key] of this) {\n      yield key\n    }\n  }\n\n  *values() {\n    for (const [, value] of this) {\n      yield value\n    }\n  }\n\n  *[Symbol.iterator]() {\n    for (const item of this.cache) {\n      yield item\n    }\n\n    for (const item of this.oldCache) {\n      const [key] = item\n      if (!this.cache.has(key)) {\n        yield item\n      }\n    }\n  }\n\n  get size() {\n    let oldCacheSize = 0\n    for (const key of this.oldCache.keys()) {\n      if (!this.cache.has(key)) {\n        oldCacheSize += 1\n      }\n    }\n\n    return this._size + oldCacheSize\n  }\n}\n\nexport default QuickLRU\n","import { IndexedFasta } from '@gmod/indexedfasta'\nimport {\n  BaseSequenceAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { FileLocation, NoAssemblyRegion } from '@jbrowse/core/util/types'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { SimpleFeature, Feature } from '@jbrowse/core/util'\nimport { AnyConfigurationModel } from '@jbrowse/core/configuration'\nimport AbortablePromiseCache from 'abortable-promise-cache'\nimport LRU from '@jbrowse/core/util/QuickLRU'\nimport PluginManager from '@jbrowse/core/PluginManager'\nimport { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\n\nexport default class extends BaseSequenceAdapter {\n  protected fasta: IndexedFasta\n\n  protected header?: Promise<string>\n\n  private seqCache = new AbortablePromiseCache({\n    cache: new LRU({ maxSize: 200 }),\n    fill: async (\n      args: { refName: string; start: number; end: number },\n      signal?: AbortSignal,\n    ) => {\n      const { refName, start, end } = args\n      return this.fasta.getSequence(refName, start, end, { ...args, signal })\n    },\n  })\n\n  public constructor(\n    config: AnyConfigurationModel,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    const fastaLocation = this.getConf('fastaLocation')\n    const faiLocation = this.getConf('faiLocation')\n    const fastaOpts = {\n      fasta: openLocation(fastaLocation as FileLocation, this.pluginManager),\n      fai: openLocation(faiLocation as FileLocation, this.pluginManager),\n    }\n\n    this.fasta = new IndexedFasta(fastaOpts)\n  }\n\n  public getRefNames(opts?: BaseOptions) {\n    return this.fasta.getSequenceNames(opts)\n  }\n\n  public async getRegions(opts?: BaseOptions) {\n    const seqSizes = await this.fasta.getSequenceSizes(opts)\n    return Object.keys(seqSizes).map(refName => ({\n      refName,\n      start: 0,\n      end: seqSizes[refName],\n    }))\n  }\n\n  public async getHeader() {\n    if (this.header) {\n      return this.header\n    }\n    const loc = this.getConf('metadataLocation')\n\n    if (loc.uri === '' || loc.uri === '/path/to/fa.metadata.yaml') {\n      return null\n    }\n\n    this.header = openLocation(loc)\n      .readFile('utf8')\n      .catch(e => {\n        this.header = undefined\n        throw e\n      })\n\n    return this.header\n  }\n\n  public getFeatures(region: NoAssemblyRegion, opts?: BaseOptions) {\n    const { refName, start, end } = region\n    return ObservableCreate<Feature>(async observer => {\n      const size = await this.fasta.getSequenceSize(refName, opts)\n      const regionEnd = size !== undefined ? Math.min(size, end) : end\n      const chunks = []\n      const chunkSize = 128000\n\n      const s = start - (start % chunkSize)\n      const e = end + (chunkSize - (end % chunkSize))\n      for (let chunkStart = s; chunkStart < e; chunkStart += chunkSize) {\n        const r = {\n          refName,\n          start: chunkStart,\n          end: chunkStart + chunkSize,\n        }\n        chunks.push(this.seqCache.get(JSON.stringify(r), r, opts?.signal))\n      }\n      const seq = (await Promise.all(chunks))\n        .join('')\n        .slice(start - s)\n        .slice(0, end - start)\n      if (seq) {\n        observer.next(\n          new SimpleFeature({\n            id: `${refName} ${start}-${regionEnd}`,\n            data: { refName, start, end: regionEnd, seq },\n          }),\n        )\n      }\n      observer.complete()\n    })\n  }\n\n  /**\n   * called to provide a hint that data tied to a certain region\n   * will not be needed for the forseeable future and can be purged\n   * from caches, etc\n   */\n  public freeResources(/* { region } */): void {}\n}\n"],"names":["QuickLRU","options","maxSize","TypeError","this","cache","Map","oldCache","_size","key","value","set","has","get","delete","_set","deleted","clear","item","oldCacheSize","keys","Symbol","iterator","config","getSubAdapter","pluginManager","fasta","header","seqCache","AbortablePromiseCache","LRU","fill","args","signal","refName","start","end","getSequence","fastaLocation","getConf","faiLocation","fastaOpts","openLocation","fai","IndexedFasta","opts","getSequenceNames","getSequenceSizes","seqSizes","Object","map","loc","uri","readFile","catch","e","undefined","region","ObservableCreate","observer","getSequenceSize","size","regionEnd","Math","min","chunks","chunkSize","chunkStart","s","r","push","JSON","stringify","Promise","all","seq","join","slice","next","SimpleFeature","id","data","complete","BaseSequenceAdapter"],"sourceRoot":""}