"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[8724,1631],{38724:(e,t,n)=>{n.r(t),n.d(t,{default:()=>m});var r=n(72600),a=n(57810),s=n(92813),o=n(95454),i=n(36349),c=n(71631),l=n(1828),h=n(72045),f=n(32806);function u(e){const[t,n]=e.reduce((([e,t],[n,r])=>[e+n*r,t+r]),[0,0]);return t/n}const{parseCigar:d}=l.MismatchParser;class m extends r.BaseFeatureDataAdapter{static capabilities=["getFeatures","getRefNames"];async setup(e){return this.setupP||(this.setupP=this.setupPre(e).catch((e=>{throw this.setupP=void 0,e}))),this.setupP}async setupPre(e){const t=this.pluginManager,n=(0,s.openLocation)(this.getConf("pafLocation"),t),r=await n.readFile(e),a=(0,f.lq)(r)?await(0,c.unzip)(r):r;return(0,f.WU)(a,f.Ow)}async hasDataForRefName(){return!0}getAssemblyNames(){const e=this.getConf("assemblyNames");return 0===e.length?[this.getConf("queryAssembly"),this.getConf("targetAssembly")]:e}async getRefNames(e={}){const t=e.regions?.[0].assemblyName,n=await this.setup(e),r=this.getAssemblyNames().indexOf(t);if(-1!==r){const e=new Set;for(const t of n)e.add(0===r?t.qname:t.tname);return[...e]}return console.warn("Unable to do ref renaming on adapter"),[]}getFeatures(e,t={}){return(0,o.ObservableCreate)((async n=>{let r=await this.setup(t);const{config:s}=t;s&&"meanQueryIdentity"===(0,i.readConfObject)(s,"colorBy")&&(r=function(e){const t={};for(const n of e){const e=n.qname+"-"+n.tname;t[e]||(t[e]={quals:[],len:[]}),t[e].quals.push(n.extra.mappingQual),t[e].len.push(n.extra.blockLen||1)}const n=Object.fromEntries(Object.entries(t).map((([e,t])=>[e,u((0,f.$R)(t.quals,t.len))])));for(const t of e){const e=t.qname+"-"+t.tname;t.extra.meanScore=n[e]}let r=1e4,a=0;for(const t of e)r=Math.min(t.extra.meanScore||0,r),a=Math.max(t.extra.meanScore||0,a);for(const t of e){const e=t.extra.meanScore||0;t.extra.meanScore=(e-r)/(a-r)}return e}(r));const o=this.getAssemblyNames(),{start:c,end:l,refName:m,assemblyName:g}=e,p=o.indexOf(g),w=0===p;-1===p&&(console.warn(`${g} not found in this adapter`),n.complete());for(let e=0;e<r.length;e++){const t=r[e];let s=0,i=0,u="",p="",b=0,y=0;w?(s=t.qstart,i=t.qend,u=t.qname,p=t.tname,b=t.tstart,y=t.tend):(s=t.tstart,i=t.tend,u=t.tname,p=t.qname,b=t.qstart,y=t.qend);const{extra:x,strand:k}=t;if(u===m&&(0,a.qY)(c,l,s,i)){const{numMatches:t=0,blockLen:r=1,cg:a,...c}=x;let l=x.cg;x.cg&&(w&&-1===k?l=(0,f.Kl)(d(x.cg)).join(""):w&&(l=(0,f.G9)(x.cg))),n.next(new h.Z({uniqueId:e+g,assemblyName:g,start:s,end:i,type:"match",refName:u,strand:k,...c,CIGAR:l,syntenyId:e,identity:t/r,numMatches:t,blockLen:r,mate:{start:b,end:y,refName:p,assemblyName:o[+w]}}))}}n.complete()}))}freeResources(){}}},72045:(e,t,n)=>{n.d(t,{Z:()=>o});var r=n(31211),a=n(1828);const{getMismatches:s}=a.MismatchParser;class o extends r.SimpleFeature{get(e){return"mismatches"===e?s(this.get("CIGAR")):super.get(e)}}},32806:(e,t,n)=>{n.d(t,{$R:()=>i,G9:()=>u,Kl:()=>f,Ow:()=>h,SN:()=>s,WU:()=>l,lq:()=>a,pJ:()=>o});var r=n(71631);function a(e){return 31===e[0]&&139===e[1]&&8===e[2]}function s(e){return new Map(e.split(/\n|\r\n|\r/).filter((e=>!!e||e.startsWith("#"))).map((e=>{const[t,n,r,a,s,o]=e.split("\t");return[a,{refName:t,start:+n,end:+r,score:+s,name:a,strand:"-"===o?-1:1}]})))}async function o(e,t){const n=await e.readFile(t);return new TextDecoder("utf8",{fatal:!0}).decode(a(n)?await(0,r.unzip)(n):n)}function i(e,t){return e.map(((e,n)=>[e,t[n]]))}const c="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function l(e,t){let n=0;const r=[];for(;n<e.length;){const a=e.indexOf("\n",n);if(-1===a)break;const s=e.slice(n,a),o=(c?.decode(s)||s.toString()).trim();o&&r.push(t(o)),n=a+1}return r}function h(e){const[t,,n,r,a,s,,o,i,c,l,h,...f]=e.split("\t");return{tname:s,tstart:+o,tend:+i,qname:t,qstart:+n,qend:+r,strand:"-"===a?-1:1,extra:{numMatches:+c,blockLen:+l,mappingQual:+h,...Object.fromEntries(f.map((e=>{const t=e.indexOf(":");return[e.slice(0,t),e.slice(t+3)]})))}}}function f(e){const t=[];for(let n=e.length-2;n>=0;n-=2){t.push(e[n]);const r=e[n+1];"D"===r?t.push("I"):"I"===r?t.push("D"):t.push(r)}return t}function u(e){return e.replaceAll("D","K").replaceAll("I","D").replaceAll("K","I")}},71631:(e,t,n)=>{n.d(t,{q5:()=>f,unzip:()=>o,y$:()=>i});var r=n(18390),a=n(90510),s=n(96553);async function o(e){try{let t,n=0,a=0;const o=[];let i,c=0;do{const r=e.subarray(n);if(i=new s.Inflate,({strm:t}=i),i.push(r,s.Z_SYNC_FLUSH),i.err)throw new Error(i.msg);n+=t.next_in,o[a]=i.result,c+=o[a].length,a+=1}while(t.avail_in);const l=new Uint8Array(c);for(let e=0,t=0;e<o.length;e++)l.set(o[e],t),t+=o[e].length;return r.Buffer.from(l)}catch(e){if(`${e}`.match(/incorrect header check/))throw new Error("problem decompressing block: incorrect gzip header check");throw e}}async function i(e,t){try{let n;const{minv:a,maxv:o}=t;let i=a.blockPosition,c=a.dataPosition;const l=[],h=[],f=[];let u=0,d=0;do{const t=e.subarray(i-a.blockPosition),r=new s.Inflate;if(({strm:n}=r),r.push(t,s.Z_SYNC_FLUSH),r.err)throw new Error(r.msg);const m=r.result;l.push(m);let g=m.length;h.push(i),f.push(c),1===l.length&&a.dataPosition&&(l[0]=l[0].subarray(a.dataPosition),g=l[0].length);const p=i;if(i+=n.next_in,c+=g,p>=o.blockPosition){l[d]=l[d].subarray(0,o.blockPosition===a.blockPosition?o.dataPosition-a.dataPosition+1:o.dataPosition+1),h.push(i),f.push(c),u+=l[d].length;break}u+=l[d].length,d++}while(n.avail_in);const m=new Uint8Array(u);for(let e=0,t=0;e<l.length;e++)m.set(l[e],t),t+=l[e].length;return{buffer:r.Buffer.from(m),cpositions:h,dpositions:f}}catch(e){if(`${e}`.match(/incorrect header check/))throw new Error("problem decompressing block: incorrect gzip header check");throw e}}var c=n(84574),l=n.n(c);class h{constructor({filehandle:e,path:t}){if(e)this.filehandle=e;else{if(!t)throw new TypeError("either filehandle or path must be defined");this.filehandle=new a.S9(t)}}_readLongWithOverflow(e,t=0,n=!0){const r=l().fromBytesLE(e.slice(t,t+8),n);if(r.greaterThan(Number.MAX_SAFE_INTEGER)||r.lessThan(Number.MIN_SAFE_INTEGER))throw new TypeError("integer overflow");return r.toNumber()}_getIndex(){return this.index||(this.index=this._readIndex()),this.index}async _readIndex(){let e=r.Buffer.allocUnsafe(8);await this.filehandle.read(e,0,8,0);const t=this._readLongWithOverflow(e,0,!0);if(!t)return[[0,0]];const n=new Array(t+1);n[0]=[0,0];const a=16*t;if(a>Number.MAX_SAFE_INTEGER)throw new TypeError("integer overflow");e=r.Buffer.allocUnsafe(a),await this.filehandle.read(e,0,a,8);for(let r=0;r<t;r+=1){const t=this._readLongWithOverflow(e,16*r),a=this._readLongWithOverflow(e,16*r+8);n[r+1]=[t,a]}return n}async getLastBlock(){const e=await this._getIndex();if(e.length)return e[e.length-1]}async getRelevantBlocksForRead(e,t){const n=t+e;if(0===e)return[];const r=await this._getIndex(),a=[],s=(e,n)=>{const r=e[1],a=n?n[1]:1/0;return r<=t&&a>t?0:r<t?-1:1};let o=0,i=r.length-1,c=Math.floor(r.length/2),l=s(r[c],r[c+1]);for(;0!==l;)l>0?i=c-1:l<0&&(o=c+1),c=Math.ceil((i-o)/2)+o,l=s(r[c],r[c+1]);a.push(r[c]);let h=c+1;for(;h<r.length&&(a.push(r[h]),!(r[h][1]>=n));h+=1);return a[a.length-1][1]<n&&a.push([]),a}}class f{constructor({filehandle:e,path:t,gziFilehandle:n,gziPath:r}){if(e)this.filehandle=e;else{if(!t)throw new TypeError("either filehandle or path must be defined");this.filehandle=new a.S9(t)}if(!n&&!r&&!t)throw new TypeError("either gziFilehandle or gziPath must be defined");this.gzi=new h({filehandle:n,path:n||r||!t?`${t}.gzi`:r})}async stat(){const e=await this.filehandle.stat();return Object.assign(e,{size:await this.getUncompressedFileSize(),blocks:void 0,blksize:void 0})}async getUncompressedFileSize(){const[,e]=await this.gzi.getLastBlock(),{size:t}=await this.filehandle.stat(),n=r.Buffer.allocUnsafe(4),{bytesRead:a}=await this.filehandle.read(n,0,4,t-28-4);if(4!==a)throw new Error("read error");return e+n.readUInt32LE(0)}async _readAndUncompressBlock(e,[t],[n]){let r=n;r||(r=(await this.filehandle.stat()).size);const a=r-t;return await this.filehandle.read(e,0,a,t),await o(e.slice(0,a))}async read(e,t,n,a){const s=await this.gzi.getRelevantBlocksForRead(n,a),o=r.Buffer.allocUnsafe(65536);let i=t,c=0;for(let t=0;t<s.length-1;t+=1){const r=await this._readAndUncompressBlock(o,s[t],s[t+1]),[,l]=s[t],h=l>=a?0:a-l,f=Math.min(a+n,l+r.length)-l;h>=0&&h<r.length&&(r.copy(e,i,h,f),i+=f-h,c+=f-h)}return{bytesRead:c,buffer:e}}}}}]);
//# sourceMappingURL=8724.f0c94b0c.chunk.js.map