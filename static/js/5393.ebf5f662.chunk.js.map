{"version":3,"file":"static/js/5393.ebf5f662.chunk.js","mappings":"sWAyCMA,EAAwB,WAC5B,WAAoBC,IAAgC,oBAAhCA,WAAAA,CAAgC,CAWnD,OAXoD,qEAErD,WAAWC,EAAkBC,GAAc,gGACFC,KAAKH,WAAWI,KACrDC,EAAOC,YAAYJ,GACnB,EACAA,EACAD,GACD,OAL2B,OAK3B,SALeM,EAAC,EAATC,OAAWC,EAAS,EAATA,UAAS,kBAOrBF,EAAEC,OAAOE,MAAMH,EAAEI,WAAYJ,EAAEI,WAAaF,IAAU,gDAC9D,qDAXoD,MAWpD,EAZ2B,GAcvB,SAASG,EAAsBC,GACpC,OAAO,IAAId,GAAyBe,EAAAA,EAAAA,cAAaD,GACnD,CAAC,IAaoBE,EAAU,0CAG7B,WACEC,EACAC,EACAC,GACC,IAAD,mBACA,cAAMF,EAAQC,EAAeC,IAPvBC,SAAG,EAQT,IAAMC,EAAc,EAAKC,QAAQ,eAG/B,OAFF,EAAKF,IAAM,IAAIG,EAAAA,EAAS,CACtBC,KAAMX,EAAsBQ,KAC5B,CACJ,CA8DwC,OA9DvC,sEAED,WAAoBI,GAAkB,gFAEK,OADO,GAAVA,GAAQ,CAAC,GAAvCC,gBAAAA,OAAc,MAAG,WAAO,EAAC,GAClB,2BAA0B,SACpBtB,KAAKgB,IAAIO,cAAa,OACzB,OADZC,EAAM,OACZF,EAAe,IAAG,kBACXE,GAAM,gDACd,mDARA,IAQA,gEAED,WAAuBH,GAAkB,8FACrBrB,KAAKyB,MAAMJ,GAAK,OACE,OAD9BK,EAAG,OACwBA,EAAzBC,YAAgBC,GAAI,OAAKF,EAAG,qBAC7BE,GAAI,gDACZ,mDANA,IAMA,kEAED,WAAkBP,GAAkB,4FACXrB,KAAKyB,MAAMJ,GAAK,OAAzB,OAARQ,EAAQ,yBACPA,EAASF,YAAYG,KAAI,SAAAC,GAAG,OAAIA,EAAIC,IAAI,KAAC,gDACjD,mDALA,IAKA,oEAED,WAAoBC,EAAiBZ,GAAkB,oGAC9BrB,KAAKyB,MAAMJ,GAAK,OAIvC,IAJMQ,EAAQ,OACNK,EAAgBL,EAAhBK,YACJC,EAAmBD,EAAYA,EAAYnC,OAAS,GAE/CqC,EAAIF,EAAYnC,OAAS,EAAGqC,GAAK,EAAGA,GAAK,GAC1CC,EAAIH,EAAYE,KACb,EAAIH,IACXE,EAAmBE,GAEtB,yBACMF,GAAgB,gDACxB,qDAdA,IAcA,yBAED,SAAYG,GAAwC,IAAD,OAAvBjB,EAAgB,uDAAG,CAAC,EAC9C,OAAOkB,EAAAA,EAAAA,kBAAgB,yCAAgB,WAAMC,GAAQ,4FAEO,OADzCT,EAAoBO,EAA7BG,QAAcC,EAAeJ,EAAfI,MAAOC,EAAQL,EAARK,IACrBC,EAAuDvB,EAAvDuB,WAAW,EAA4CvB,EAA3CY,QAAAA,OAAO,MAAG,EAAC,IAAgCZ,EAA9BC,eAAAA,OAAc,MAAG,WAAO,EAAC,WACxC,EAAKuB,cAAcZ,GAAWW,GAAc,KAAOvB,GAAK,OACnC,OADjCyB,EAAG,OACTxB,EAAe,yBAAwB,SAEjB,EAAKN,IAAI+B,kBAC7B,KACA,CAAEL,MAAAA,EAAOX,IAAAA,EAAKY,IAAAA,GACd,CAAED,MAAAA,EAAOX,IAAAA,EAAKY,IAAAA,GACd,KACAG,GACD,OANY,OAOLE,SAAQ,SAAAC,GACdT,EAASU,KAAKD,EAChB,IACA3B,EAAe,IACfkB,EAASW,WAAU,4CACpB,mDAlBsB,GAkBpB9B,EAAK+B,OACV,GAEA,2EACA,WAA2BC,GAAkB,+FACpC,CAAEC,eAAgB,IAAG,2CAC7B,mDAHD,IAGC,2BAED,WAAuC,KAAC,EA3EX,CAASC,EAAAA,uB","sources":["../../../plugins/hic/src/HicAdapter/HicAdapter.ts"],"sourcesContent":["import {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { Region, FileLocation } from '@jbrowse/core/util/types'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport type { GenericFilehandle } from 'generic-filehandle'\nimport HicStraw from 'hic-straw'\nimport PluginManager from '@jbrowse/core/PluginManager'\nimport { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\nimport { AnyConfigurationModel } from '@jbrowse/core/configuration'\n\ninterface ContactRecord {\n  bin1: number\n  bin2: number\n  counts: number\n}\n\ninterface HicMetadata {\n  chromosomes: {\n    name: string\n    length: number\n    id: number\n  }[]\n  resolutions: number[]\n}\ninterface Ref {\n  chr: string\n  start: number\n  end: number\n}\n\ninterface HicOptions extends BaseOptions {\n  resolution?: number\n  bpPerPx?: number\n}\n\n// wraps generic-filehandle so the read function only takes a position and length\n// in some ways, generic-filehandle wishes it was just this but it has\n// to adapt to the node.js fs promises API\nclass GenericFilehandleWrapper {\n  constructor(private filehandle: GenericFilehandle) {}\n\n  async read(position: number, length: number) {\n    const { buffer: b, bytesRead } = await this.filehandle.read(\n      Buffer.allocUnsafe(length),\n      0,\n      length,\n      position,\n    )\n    // xref https://stackoverflow.com/a/31394257/2129219\n    return b.buffer.slice(b.byteOffset, b.byteOffset + bytesRead)\n  }\n}\nexport function openFilehandleWrapper(location: FileLocation) {\n  return new GenericFilehandleWrapper(openLocation(location))\n}\n\ninterface HicParser {\n  getContactRecords: (\n    normalize: string,\n    ref: Ref,\n    ref2: Ref,\n    units: string,\n    binsize: number,\n  ) => Promise<ContactRecord[]>\n  getMetaData: () => Promise<HicMetadata>\n}\n\nexport default class HicAdapter extends BaseFeatureDataAdapter {\n  private hic: HicParser\n\n  public constructor(\n    config: AnyConfigurationModel,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    const hicLocation = this.getConf('hicLocation')\n    this.hic = new HicStraw({\n      file: openFilehandleWrapper(hicLocation),\n    })\n  }\n\n  private async setup(opts?: BaseOptions) {\n    const { statusCallback = () => {} } = opts || {}\n    statusCallback('Downloading .hic header')\n    const result = await this.hic.getMetaData()\n    statusCallback('')\n    return result\n  }\n\n  public async getHeader(opts?: BaseOptions) {\n    const ret = await this.setup(opts)\n    const { chromosomes, ...rest } = ret\n    return rest\n  }\n\n  async getRefNames(opts?: BaseOptions) {\n    const metadata = await this.setup(opts)\n    return metadata.chromosomes.map(chr => chr.name)\n  }\n\n  async getResolution(bpPerPx: number, opts?: BaseOptions) {\n    const metadata = await this.setup(opts)\n    const { resolutions } = metadata\n    let chosenResolution = resolutions[resolutions.length - 1]\n\n    for (let i = resolutions.length - 1; i >= 0; i -= 1) {\n      const r = resolutions[i]\n      if (r <= 2 * bpPerPx) {\n        chosenResolution = r\n      }\n    }\n    return chosenResolution\n  }\n\n  getFeatures(region: Region, opts: HicOptions = {}) {\n    return ObservableCreate<ContactRecord>(async observer => {\n      const { refName: chr, start, end } = region\n      const { resolution, bpPerPx = 1, statusCallback = () => {} } = opts\n      const res = await this.getResolution(bpPerPx / (resolution || 1000), opts)\n      statusCallback('Downloading .hic data')\n\n      const records = await this.hic.getContactRecords(\n        'KR',\n        { start, chr, end },\n        { start, chr, end },\n        'BP',\n        res,\n      )\n      records.forEach(record => {\n        observer.next(record)\n      })\n      statusCallback('')\n      observer.complete()\n    }, opts.signal) as any // eslint-disable-line @typescript-eslint/no-explicit-any\n  }\n\n  // don't do feature stats estimation, similar to bigwigadapter\n  async estimateRegionsStats(_regions: Region[]) {\n    return { featureDensity: 0 }\n  }\n\n  freeResources(/* { region } */): void {}\n}\n"],"names":["GenericFilehandleWrapper","filehandle","position","length","this","read","Buffer","allocUnsafe","b","buffer","bytesRead","slice","byteOffset","openFilehandleWrapper","location","openLocation","HicAdapter","config","getSubAdapter","pluginManager","hic","hicLocation","getConf","HicStraw","file","opts","statusCallback","getMetaData","result","setup","ret","chromosomes","rest","metadata","map","chr","name","bpPerPx","resolutions","chosenResolution","i","r","region","ObservableCreate","observer","refName","start","end","resolution","getResolution","res","getContactRecords","forEach","record","next","complete","signal","_regions","featureDensity","BaseFeatureDataAdapter"],"sourceRoot":""}