{"version":3,"file":"static/js/8537.d1f50e22.chunk.js","mappings":"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","sources":["../../../plugins/gff3/src/Gff3Adapter/Gff3Adapter.ts"],"sourcesContent":["import {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { NoAssemblyRegion } from '@jbrowse/core/util/types'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport IntervalTree from '@flatten-js/interval-tree'\nimport SimpleFeature, { Feature } from '@jbrowse/core/util/simpleFeature'\nimport { unzip } from '@gmod/bgzf-filehandle'\n\nimport gff, { GFF3FeatureLineWithRefs } from '@gmod/gff'\n\nfunction isGzip(buf: Buffer) {\n  return buf[0] === 31 && buf[1] === 139 && buf[2] === 8\n}\n\nexport default class extends BaseFeatureDataAdapter {\n  protected gffFeatures?: Promise<{\n    header: string\n    intervalTree: Record<string, IntervalTree>\n  }>\n\n  private async loadDataP() {\n    const pm = this.pluginManager\n    const buf = await openLocation(this.getConf('gffLocation'), pm).readFile()\n    const buffer = isGzip(buf) ? await unzip(buf) : buf\n    // 512MB  max chrome string length is 512MB\n    if (buffer.length > 536_870_888) {\n      throw new Error('Data exceeds maximum string length (512MB)')\n    }\n    const data = new TextDecoder('utf8', { fatal: true }).decode(buffer)\n    const lines = data.split(/\\n|\\r\\n|\\r/)\n    const headerLines = []\n    for (let i = 0; i < lines.length && lines[i].startsWith('#'); i++) {\n      headerLines.push(lines[i])\n    }\n    const header = headerLines.join('\\n')\n\n    const feats = gff.parseStringSync(data, {\n      parseFeatures: true,\n      parseComments: false,\n      parseDirectives: false,\n      parseSequences: false,\n      disableDerivesFromReferences: true,\n    })\n\n    const intervalTree = {} as Record<string, IntervalTree>\n    for (const obj of feats.flat().map(\n      (f, i) =>\n        new SimpleFeature({\n          data: this.featureData(f),\n          id: `${this.id}-offset-${i}`,\n        }),\n    )) {\n      const key = obj.get('refName')\n      if (!intervalTree[key]) {\n        intervalTree[key] = new IntervalTree()\n      }\n      intervalTree[key].insert([obj.get('start'), obj.get('end')], obj)\n    }\n\n    return { header, intervalTree }\n  }\n\n  private async loadData() {\n    if (!this.gffFeatures) {\n      this.gffFeatures = this.loadDataP().catch(e => {\n        this.gffFeatures = undefined\n        throw e\n      })\n    }\n\n    return this.gffFeatures\n  }\n\n  public async getRefNames(_opts: BaseOptions = {}) {\n    const { intervalTree } = await this.loadData()\n    return Object.keys(intervalTree)\n  }\n\n  public async getHeader() {\n    const { header } = await this.loadData()\n    return header\n  }\n\n  public getFeatures(query: NoAssemblyRegion, opts: BaseOptions = {}) {\n    return ObservableCreate<Feature>(async observer => {\n      try {\n        const { start, end, refName } = query\n        const { intervalTree } = await this.loadData()\n        intervalTree[refName]\n          ?.search([start, end])\n          .forEach(f => observer.next(f))\n        observer.complete()\n      } catch (e) {\n        observer.error(e)\n      }\n    }, opts.signal)\n  }\n\n  private featureData(data: GFF3FeatureLineWithRefs) {\n    const f: Record<string, unknown> = { ...data }\n    ;(f.start as number) -= 1 // convert to interbase\n    if (data.strand === '+') {\n      f.strand = 1\n    } else if (data.strand === '-') {\n      f.strand = -1\n    } else if (data.strand === '.') {\n      f.strand = 0\n    } else {\n      f.strand = undefined\n    }\n    f.phase = Number(data.phase)\n    f.refName = data.seq_id\n    if (data.score === null) {\n      delete f.score\n    }\n    if (data.phase === null) {\n      delete f.score\n    }\n    const defaultFields = new Set([\n      'start',\n      'end',\n      'seq_id',\n      'score',\n      'type',\n      'source',\n      'phase',\n      'strand',\n    ])\n    const dataAttributes = data.attributes || {}\n    for (const a of Object.keys(dataAttributes)) {\n      let b = a.toLowerCase()\n      if (defaultFields.has(b)) {\n        // add \"suffix\" to tag name if it already exists\n        // reproduces behavior of NCList\n        b += '2'\n      }\n      if (dataAttributes[a] !== null) {\n        let attr: string | string[] | undefined = dataAttributes[a]\n        if (Array.isArray(attr) && attr.length === 1) {\n          ;[attr] = attr\n        }\n        f[b] = attr\n      }\n    }\n    f.refName = f.seq_id\n\n    // the SimpleFeature constructor takes care of recursively inflating subfeatures\n    if (data.child_features && data.child_features.length > 0) {\n      f.subfeatures = data.child_features.flatMap(childLocs =>\n        childLocs.map(childLoc => this.featureData(childLoc)),\n      )\n    }\n\n    delete f.child_features\n    delete f.data\n    // delete f.derived_features\n    delete f.attributes\n    delete f.seq_id\n    return f\n  }\n\n  public freeResources(/* { region } */) {}\n}\n"],"names":["isGzip","buf","_default","_BaseFeatureDataAdapt","_inherits","_super","_createSuper","_this","_classCallCheck","_len","arguments","length","args","Array","_key","call","apply","concat","gffFeatures","_createClass","key","value","_loadDataP","_asyncToGenerator","_regeneratorRuntime","mark","_callee","pm","buffer","data","lines","headerLines","i","header","feats","intervalTree","_iterator","_step","obj","_this2","wrap","_context","prev","next","this","pluginManager","openLocation","getConf","readFile","sent","unzip","t0","Error","TextDecoder","fatal","decode","split","startsWith","push","join","gff","parseStringSync","parseFeatures","parseComments","parseDirectives","parseSequences","disableDerivesFromReferences","_createForOfIteratorHelper","flat","map","f","SimpleFeature","featureData","id","s","n","done","get","IntervalTree","insert","err","e","abrupt","stop","_loadData","_callee2","_this3","_context2","loadDataP","catch","undefined","_getRefNames","_callee3","_yield$this$loadData","_args3","_context3","loadData","Object","keys","_getHeader","_callee4","_yield$this$loadData2","_context4","query","_this4","opts","ObservableCreate","_ref","_callee5","observer","_intervalTree$refName","start","end","refName","_yield$_this4$loadDat","_context5","search","forEach","complete","error","_x","signal","_this5","_objectSpread","strand","phase","Number","seq_id","score","defaultFields","Set","dataAttributes","attributes","_i","_Object$keys","a","b","toLowerCase","has","attr","isArray","_attr","_slicedToArray","child_features","subfeatures","flatMap","childLocs","childLoc","BaseFeatureDataAdapter"],"sourceRoot":""}