{"version":3,"file":"static/js/6980.8d5e4653.chunk.js","mappings":"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","sources":["../../../plugins/variants/src/VcfAdapter/VcfAdapter.ts"],"sourcesContent":["import {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { Region, Feature } from '@jbrowse/core/util'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport IntervalTree from '@flatten-js/interval-tree'\nimport { unzip } from '@gmod/bgzf-filehandle'\nimport VCF from '@gmod/vcf'\n\n// local\nimport VcfFeature from '../VcfFeature'\n\nconst readVcf = (f: string) => {\n  const header: string[] = []\n  const rest: string[] = []\n  f.split(/\\n|\\r\\n|\\r/)\n    .map(f => f.trim())\n    .filter(f => !!f)\n    .forEach(line => {\n      if (line.startsWith('#')) {\n        header.push(line)\n      } else if (line) {\n        rest.push(line)\n      }\n    })\n  return { header: header.join('\\n'), lines: rest }\n}\n\nfunction isGzip(buf: Buffer) {\n  return buf[0] === 31 && buf[1] === 139 && buf[2] === 8\n}\n\nexport default class VcfAdapter extends BaseFeatureDataAdapter {\n  public static capabilities = ['getFeatures', 'getRefNames']\n\n  protected vcfFeatures?: Promise<{\n    header: string\n    intervalTree: Record<string, IntervalTree>\n  }>\n\n  public async getHeader() {\n    const { header } = await this.setup()\n    return header\n  }\n\n  async getMetadata() {\n    const { header } = await this.setup()\n    const parser = new VCF({ header: header })\n    return parser.getMetadata()\n  }\n\n  // converts lines into an interval tree\n  public async setupP() {\n    const pm = this.pluginManager\n    const buf = await openLocation(this.getConf('vcfLocation'), pm).readFile()\n\n    const buffer = isGzip(buf) ? await unzip(buf) : buf\n\n    // 512MB  max chrome string length is 512MB\n    if (buffer.length > 536_870_888) {\n      throw new Error('Data exceeds maximum string length (512MB)')\n    }\n\n    const str = new TextDecoder().decode(buffer)\n    const { header, lines } = readVcf(str)\n    const intervalTree = {} as { [key: string]: IntervalTree }\n\n    for (const obj of lines.map((line, id) => {\n      const [refName, startP, , ref, , , , info] = line.split('\\t')\n      const start = +startP - 1\n      const def = start + ref.length\n      const end = +(info.match(/END=(\\d+)/)?.[1].trim() || def)\n      return { line, refName, start, end, id }\n    })) {\n      const key = obj.refName\n      if (!intervalTree[key]) {\n        intervalTree[key] = new IntervalTree()\n      }\n      intervalTree[key].insert([obj.start, obj.end], obj)\n    }\n\n    return { header, intervalTree }\n  }\n\n  public async setup() {\n    if (!this.vcfFeatures) {\n      this.vcfFeatures = this.setupP().catch(e => {\n        this.vcfFeatures = undefined\n        throw e\n      })\n    }\n    return this.vcfFeatures\n  }\n\n  public async getRefNames(_: BaseOptions = {}) {\n    const { intervalTree } = await this.setup()\n    return Object.keys(intervalTree)\n  }\n\n  public getFeatures(region: Region, opts: BaseOptions = {}) {\n    return ObservableCreate<Feature>(async observer => {\n      try {\n        const { start, end, refName } = region\n        const { header, intervalTree } = await this.setup()\n        const parser = new VCF({ header })\n        intervalTree[refName]?.search([start, end]).forEach(f =>\n          observer.next(\n            new VcfFeature({\n              variant: parser.parseLine(f.line),\n              parser,\n              id: `${this.id}-${f.id}`,\n            }),\n          ),\n        )\n        observer.complete()\n      } catch (e) {\n        observer.error(e)\n      }\n    }, opts.signal)\n  }\n\n  public freeResources(): void {}\n}\n"],"names":["readVcf","f","header","rest","split","map","trim","filter","forEach","line","startsWith","push","join","lines","isGzip","buf","VcfAdapter","_BaseFeatureDataAdapt","_inherits","_super","_createSuper","_this","_classCallCheck","_len","arguments","length","args","Array","_key","call","apply","concat","vcfFeatures","_createClass","key","value","_getHeader","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_yield$this$setup","wrap","_context","prev","next","this","setup","sent","abrupt","stop","_getMetadata","_callee2","_yield$this$setup2","parser","_context2","VCF","getMetadata","_setupP","_callee3","pm","buffer","str","_readVcf","intervalTree","_iterator","_step","obj","_key2","_context3","pluginManager","openLocation","getConf","readFile","unzip","t0","Error","TextDecoder","decode","_createForOfIteratorHelper","id","_info$match","_line$split","_line$split2","_slicedToArray","refName","startP","ref","info","start","def","end","match","s","n","done","IntervalTree","insert","err","e","_setup","_callee4","_this2","_context4","setupP","catch","undefined","_getRefNames","_callee5","_yield$this$setup3","_args5","_context5","Object","keys","region","_this3","opts","ObservableCreate","_ref","_callee6","observer","_intervalTree$refName","_yield$_this3$setup","_context6","search","VcfFeature","variant","parseLine","complete","error","_x","signal","BaseFeatureDataAdapter","capabilities"],"sourceRoot":""}