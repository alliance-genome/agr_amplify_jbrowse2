{"version":3,"file":"static/js/6849.93818f10.chunk.js","mappings":"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","sources":["../../../plugins/alignments/src/CramAdapter/CramSlightlyLazyFeature.ts","../../../plugins/alignments/src/CramAdapter/CramAdapter.ts"],"sourcesContent":["/* eslint-disable no-underscore-dangle */\nimport {\n  Feature,\n  SimpleFeatureSerialized,\n} from '@jbrowse/core/util/simpleFeature'\n\nimport CramAdapter from './CramAdapter'\n\nexport interface Mismatch {\n  qual?: number\n  start: number\n  length: number\n  type: string\n  base: string\n  altbase?: string\n  seq?: string\n  cliplen?: number\n}\n\nexport default class CramSlightlyLazyFeature implements Feature {\n  // uses parameter properties to automatically create fields on the class\n  // https://www.typescriptlang.org/docs/handbook/classes.html#parameter-properties\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  constructor(private record: any, private _store: CramAdapter) {}\n\n  _get_name() {\n    return this.record.readName\n  }\n\n  _get_start() {\n    return this.record.alignmentStart - 1\n  }\n\n  _get_end() {\n    return this.record.alignmentStart + this.record.lengthOnRef - 1\n  }\n\n  _get_cram_read_features() {\n    return this.record.readFeatures\n  }\n\n  _get_type() {\n    return 'match'\n  }\n\n  _get_score() {\n    return this.record.mappingQuality\n  }\n\n  _get_flags() {\n    return this.record.flags\n  }\n\n  _get_strand() {\n    return this.record.isReverseComplemented() ? -1 : 1\n  }\n\n  _read_group_id() {\n    const rg = this._store.samHeader.readGroups\n    return rg ? rg[this.record.readGroupId] : undefined\n  }\n\n  _get_qual() {\n    return (this.record.qualityScores || []).join(' ')\n  }\n\n  qualRaw() {\n    return this.record.qualityScores\n  }\n\n  _get_seq_id() {\n    return this._store.refIdToName(this.record.sequenceId)\n  }\n\n  _get_refName() {\n    return this._get_seq_id()\n  }\n\n  _get_is_paired() {\n    return !!this.record.mate\n  }\n\n  _get_pair_orientation() {\n    return this.record.isPaired() ? this.record.getPairOrientation() : undefined\n  }\n\n  _get_template_length() {\n    return this.record.templateLength || this.record.templateSize\n  }\n\n  _get_next_seq_id() {\n    return this.record.mate\n      ? this._store.refIdToName(this.record.mate.sequenceId)\n      : undefined\n  }\n\n  _get_next_pos() {\n    return this.record.mate ? this.record.mate.alignmentStart : undefined\n  }\n\n  _get_next_segment_position() {\n    return this.record.mate\n      ? `${this._store.refIdToName(this.record.mate.sequenceId)}:${\n          this.record.mate.alignmentStart\n        }`\n      : undefined\n  }\n\n  _get_tags() {\n    const RG = this._read_group_id()\n    const { tags } = this.record\n    // avoids a tag copy if no RG, but just copy if there is one\n    return RG !== undefined ? { ...tags, RG } : tags\n  }\n\n  _get_seq() {\n    return this.record.getReadBases()\n  }\n\n  // generate a CIGAR, based on code from jkbonfield\n  _get_CIGAR() {\n    let seq = ''\n    let cigar = ''\n    let op = 'M'\n    let oplen = 0\n\n    // not sure I should access these, but...\n    const ref = this.record._refRegion.seq\n    const refStart = this.record._refRegion.start\n    let last_pos = this.record.alignmentStart\n    let sublen = 0\n    if (typeof this.record.readFeatures !== 'undefined') {\n      // @ts-ignore\n      this.record.readFeatures.forEach(({ code, refPos, sub, data }) => {\n        sublen = refPos - last_pos\n        seq += ref.substring(last_pos - refStart, refPos - refStart)\n        last_pos = refPos\n\n        if (oplen && op !== 'M') {\n          cigar += oplen + op\n          oplen = 0\n        }\n        if (sublen) {\n          op = 'M'\n          oplen += sublen\n        }\n\n        if (code === 'b') {\n          // An array of bases stored verbatim\n          const ret = data.split(',')\n          const added = String.fromCharCode(...ret)\n          seq += added\n          last_pos += added.length\n          oplen += added.length\n        } else if (code === 'B') {\n          // Single base (+ qual score)\n          seq += sub\n          last_pos++\n          oplen++\n        } else if (code === 'X') {\n          // Substitution\n          seq += sub\n          last_pos++\n          oplen++\n        } else if (code === 'D' || code === 'N') {\n          // Deletion or Ref Skip\n          last_pos += data\n          if (oplen) {\n            cigar += oplen + op\n          }\n          cigar += data + code\n          oplen = 0\n        } else if (code === 'I' || code === 'S') {\n          // Insertion or soft-clip\n          seq += data\n          if (oplen) {\n            cigar += oplen + op\n          }\n          cigar += data.length + code\n          oplen = 0\n        } else if (code === 'i') {\n          // Single base insertion\n          seq += data\n          if (oplen) {\n            cigar += oplen + op\n          }\n          cigar += `${1}I`\n          oplen = 0\n        } else if (code === 'P') {\n          // Padding\n          if (oplen) {\n            cigar += oplen + op\n          }\n          cigar += `${data}P`\n        } else if (code === 'H') {\n          // Hard clip\n          if (oplen) {\n            cigar += oplen + op\n          }\n          cigar += `${data}H`\n          oplen = 0\n        } // else q or Q\n      })\n    } else {\n      sublen = this.record.readLength - seq.length\n    }\n    if (seq.length !== this.record.readLength) {\n      sublen = this.record.readLength - seq.length\n      seq += ref.substring(last_pos - refStart, last_pos - refStart + sublen)\n\n      if (oplen && op !== 'M') {\n        cigar += oplen + op\n        oplen = 0\n      }\n      op = 'M'\n      oplen += sublen\n    }\n    if (oplen) {\n      cigar += oplen + op\n    }\n    return cigar\n  }\n\n  tags() {\n    const properties = Object.getOwnPropertyNames(\n      CramSlightlyLazyFeature.prototype,\n    )\n    return properties\n      .filter(\n        prop =>\n          prop.startsWith('_get_') &&\n          prop !== '_get_mismatches' &&\n          prop !== '_get_cram_read_features',\n      )\n      .map(methodName => methodName.replace('_get_', ''))\n  }\n\n  id() {\n    return `${this._store.id}-${this.record.uniqueId}`\n  }\n\n  get(field: string) {\n    const methodName = `_get_${field}`\n    // @ts-ignore\n    if (this[methodName]) {\n      // @ts-ignore\n      return this[methodName]()\n    }\n    return undefined\n  }\n\n  parent(): undefined | Feature {\n    return undefined\n  }\n\n  children(): undefined | Feature[] {\n    return undefined\n  }\n\n  set(): void {}\n\n  pairedFeature() {\n    return false\n  }\n\n  _get_clipPos() {\n    const mismatches = this.get('mismatches')\n    if (mismatches.length) {\n      const record =\n        this.get('strand') === -1\n          ? mismatches[mismatches.length - 1]\n          : mismatches[0]\n      const { type, cliplen } = record\n      if (type === 'softclip' || type === 'hardclip') {\n        return cliplen\n      }\n    }\n    return 0\n  }\n\n  toJSON(): SimpleFeatureSerialized {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const tags: Record<string, any> = {}\n    this.tags().forEach((t: string) => {\n      const val = this.get(t)\n      if (val !== undefined) {\n        tags[t] = val\n      }\n    })\n\n    return {\n      ...tags,\n      name: this.get('name'),\n      type: this.get('type'),\n      uniqueId: this.id(),\n    }\n  }\n\n  _get_mismatches(): Mismatch[] {\n    const readFeatures = this.get('cram_read_features')\n    const qual = this.qualRaw()\n    if (!readFeatures) {\n      return []\n    }\n    const start = this.get('start')\n    const mismatches: Mismatch[] = []\n    readFeatures.forEach(\n      (args: {\n        code: string\n        refPos: number\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        data: any\n        pos: number\n        sub: string\n        ref: string\n      }) => {\n        const { code, pos, data, sub, ref } = args\n        const refPos = args.refPos - 1 - start\n        if (code === 'X') {\n          // substitution\n          mismatches.push({\n            start: refPos,\n            length: 1,\n            base: sub,\n            qual: qual?.[pos],\n            altbase: ref,\n            type: 'mismatch',\n          })\n        } else if (code === 'I') {\n          // insertion\n          mismatches.push({\n            start: refPos,\n            type: 'insertion',\n            base: `${data.length}`,\n            length: 0,\n          })\n        } else if (code === 'N') {\n          // reference skip\n          mismatches.push({\n            type: 'skip',\n            length: data,\n            start: refPos,\n            base: 'N',\n          })\n        } else if (code === 'S') {\n          // soft clip\n          const len = data.length\n          mismatches.push({\n            start: refPos,\n            type: 'softclip',\n            base: `S${len}`,\n            cliplen: len,\n            length: 1,\n          })\n        } else if (code === 'P') {\n          // padding\n        } else if (code === 'H') {\n          // hard clip\n          const len = data\n          mismatches.push({\n            start: refPos,\n            type: 'hardclip',\n            base: `H${len}`,\n            cliplen: len,\n            length: 1,\n          })\n        } else if (code === 'D') {\n          // deletion\n          mismatches.push({\n            type: 'deletion',\n            length: data,\n            start: refPos,\n            base: '*',\n          })\n        } else if (code === 'b') {\n          // stretch of bases\n        } else if (code === 'q') {\n          // stretch of qual scores\n        } else if (code === 'B') {\n          // a pair of [base, qual]\n        } else if (code === 'i') {\n          // single-base insertion\n          // insertion\n          mismatches.push({\n            start: refPos,\n            type: 'insertion',\n            base: data,\n            length: 1,\n          })\n        } else if (code === 'Q') {\n          // single quality value\n        }\n      },\n    )\n    return mismatches\n  }\n}\n","import { CraiIndex, IndexedCramFile } from '@gmod/cram'\nimport {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { checkAbortSignal, Region, Feature } from '@jbrowse/core/util'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { toArray } from 'rxjs/operators'\nimport CramSlightlyLazyFeature from './CramSlightlyLazyFeature'\n\ninterface HeaderLine {\n  tag: string\n  value: any // eslint-disable-line @typescript-eslint/no-explicit-any\n  data: HeaderLine[]\n}\ninterface Header {\n  idToName?: string[]\n  nameToId?: Record<string, number>\n  readGroups?: number[]\n}\n\nexport default class CramAdapter extends BaseFeatureDataAdapter {\n  samHeader: Header = {}\n\n  private setupP?: Promise<{\n    samHeader: Header\n    cram: any // eslint-disable-line @typescript-eslint/no-explicit-any\n    sequenceAdapter: any // eslint-disable-line @typescript-eslint/no-explicit-any\n  }>\n\n  // maps a refname to an id\n  private seqIdToRefName: string[] | undefined\n\n  // maps a seqId to original refname, passed specially to render args, to a seqid\n  private seqIdToOriginalRefName: string[] = []\n\n  public async configure() {\n    const cramLocation = this.getConf('cramLocation')\n    const craiLocation = this.getConf('craiLocation')\n    if (!cramLocation) {\n      throw new Error('missing cramLocation argument')\n    }\n    if (!craiLocation) {\n      throw new Error('missing craiLocation argument')\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const cram: any = new IndexedCramFile({\n      cramFilehandle: openLocation(cramLocation, this.pluginManager),\n      index: new CraiIndex({\n        filehandle: openLocation(craiLocation, this.pluginManager),\n      }),\n      seqFetch: this.seqFetch.bind(this),\n      checkSequenceMD5: false,\n      fetchSizeLimit: 200_000_000, // just make this a large size to avoid hitting it\n    })\n    // instantiate the sequence adapter\n    const sequenceAdapterType = this.getConf(['sequenceAdapter', 'type'])\n\n    if (!this.getSubAdapter) {\n      throw new Error('Error getting subadapter')\n    }\n\n    const seqConf = this.getConf('sequenceAdapter')\n    const { dataAdapter: sequenceAdapter } = await this.getSubAdapter(seqConf)\n\n    if (!(sequenceAdapter instanceof BaseFeatureDataAdapter)) {\n      throw new Error(\n        `CRAM feature adapters cannot use sequence adapters of type '${sequenceAdapterType}'`,\n      )\n    }\n\n    return { cram, sequenceAdapter }\n  }\n\n  async getHeader(opts?: BaseOptions) {\n    const { cram } = await this.configure()\n    return cram.cram.getHeaderText(opts)\n  }\n\n  private async seqFetch(seqId: number, start: number, end: number) {\n    start -= 1 // convert from 1-based closed to interbase\n\n    const { sequenceAdapter } = await this.configure()\n    const refName = this.refIdToOriginalName(seqId) || this.refIdToName(seqId)\n    if (!refName) {\n      return undefined\n    }\n\n    const seqChunks = await sequenceAdapter\n      .getFeatures({\n        refName,\n        start,\n        end,\n        assemblyName: '',\n      })\n      .pipe(toArray())\n      .toPromise()\n\n    const sequence = seqChunks\n      .sort((a, b) => a.get('start') - b.get('start'))\n      .map(chunk => {\n        const chunkStart = chunk.get('start')\n        const chunkEnd = chunk.get('end')\n        const trimStart = Math.max(start - chunkStart, 0)\n        const trimEnd = Math.min(end - chunkStart, chunkEnd - chunkStart)\n        const trimLength = trimEnd - trimStart\n        const chunkSeq = chunk.get('seq') || chunk.get('residues')\n        return chunkSeq.substr(trimStart, trimLength)\n      })\n      .join('')\n\n    if (sequence.length !== end - start) {\n      throw new Error(\n        `sequence fetch failed: fetching ${refName}:${(\n          start - 1\n        ).toLocaleString()}-${end.toLocaleString()} returned ${sequence.length.toLocaleString()} bases, but should have returned ${(\n          end - start\n        ).toLocaleString()}`,\n      )\n    }\n    return sequence\n  }\n\n  private async setupPre(opts?: BaseOptions) {\n    const { statusCallback = () => {} } = opts || {}\n    const configured = await this.configure()\n    statusCallback('Downloading index')\n    const { cram } = configured\n    const samHeader: HeaderLine[] = await cram.cram.getSamHeader(opts?.signal)\n\n    // use the @SQ lines in the header to figure out the\n    // mapping between ref ID numbers and names\n    const idToName: string[] = []\n    const nameToId: Record<string, number> = {}\n    samHeader\n      .filter(l => l.tag === 'SQ')\n      .forEach((sqLine, refId) => {\n        sqLine.data.forEach(item => {\n          if (item.tag === 'SN') {\n            // this is the ref name\n            const refName = item.value\n            nameToId[refName] = refId\n            idToName[refId] = refName\n          }\n        })\n      })\n\n    const readGroups = samHeader\n      .filter(l => l.tag === 'RG')\n      .map(rgLine => rgLine.data.find(item => item.tag === 'ID')?.value)\n\n    const data = { idToName, nameToId, readGroups }\n    statusCallback('')\n    this.samHeader = data\n    return { samHeader: data, ...configured }\n  }\n\n  private async setup(opts?: BaseOptions) {\n    if (!this.setupP) {\n      this.setupP = this.setupPre(opts).catch(e => {\n        this.setupP = undefined\n        throw e\n      })\n    }\n    return this.setupP\n  }\n\n  async getRefNames(opts?: BaseOptions) {\n    const { samHeader } = await this.setup(opts)\n    if (!samHeader.idToName) {\n      throw new Error('CRAM file has no header lines')\n    }\n    return samHeader.idToName\n  }\n\n  // use info from the SAM header if possible, but fall back to using\n  // the ref seq order from when the browser's refseqs were loaded\n  refNameToId(refName: string) {\n    if (this.samHeader.nameToId) {\n      return this.samHeader.nameToId[refName]\n    }\n    if (this.seqIdToRefName) {\n      return this.seqIdToRefName.indexOf(refName)\n    }\n    return undefined\n  }\n\n  // use info from the SAM header if possible, but fall back to using\n  // the ref seq order from when the browser's refseqs were loaded\n  refIdToName(refId: number) {\n    if (this.samHeader.idToName) {\n      return this.samHeader.idToName[refId]\n    }\n    if (this.seqIdToRefName) {\n      return this.seqIdToRefName[refId]\n    }\n    return undefined\n  }\n\n  refIdToOriginalName(refId: number) {\n    return this.seqIdToOriginalRefName[refId]\n  }\n\n  getFeatures(\n    region: Region & { originalRefName?: string },\n    opts?: BaseOptions & {\n      filterBy: {\n        flagInclude: number\n        flagExclude: number\n        tagFilter: { tag: string; value: unknown }\n        name: string\n      }\n    },\n  ) {\n    const { signal, filterBy, statusCallback = () => {} } = opts || {}\n    const { refName, start, end, originalRefName } = region\n\n    return ObservableCreate<Feature>(async observer => {\n      const { cram, sequenceAdapter } = await this.setup(opts)\n      statusCallback('Downloading alignments')\n      if (!this.seqIdToRefName) {\n        this.seqIdToRefName = await sequenceAdapter.getRefNames(opts)\n      }\n      const refId = this.refNameToId(refName)\n      if (refId !== undefined) {\n        if (originalRefName) {\n          this.seqIdToOriginalRefName[refId] = originalRefName\n        }\n        const records = await cram.getRecordsForRange(refId, start, end, opts)\n        checkAbortSignal(signal)\n        const {\n          flagInclude = 0,\n          flagExclude = 0,\n          tagFilter,\n          name,\n        } = filterBy || {}\n\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        let filtered = records.filter((record: any) => {\n          const flags = record.flags\n          return (flags & flagInclude) === flagInclude && !(flags & flagExclude)\n        })\n\n        if (tagFilter) {\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          filtered = filtered.filter((record: any) => {\n            const val = record[tagFilter.tag]\n            return val === '*' ? val !== undefined : val === tagFilter.value\n          })\n        }\n\n        if (name) {\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          filtered = filtered.filter((record: any) => record.name === name)\n        }\n\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        filtered.forEach((record: any) => {\n          observer.next(this.cramRecordToFeature(record))\n        })\n      } else {\n        console.warn('Unknown refName', refName)\n      }\n      statusCallback('')\n      observer.complete()\n    }, signal)\n  }\n\n  freeResources(/* { region } */): void {}\n\n  cramRecordToFeature(record: unknown) {\n    return new CramSlightlyLazyFeature(record, this)\n  }\n\n  // we return the configured fetchSizeLimit, and the bytes for the region\n  async estimateRegionsStats(regions: Region[], opts?: BaseOptions) {\n    const bytes = await this.bytesForRegions(regions, opts)\n    const fetchSizeLimit = this.getConf('fetchSizeLimit')\n    return {\n      bytes,\n      fetchSizeLimit,\n    }\n  }\n\n  /**\n   * get the approximate number of bytes queried from the file for the given\n   * query regions\n   * @param regions - list of query regions\n   */\n  private async bytesForRegions(regions: Region[], _opts?: BaseOptions) {\n    const { cram } = await this.configure()\n    const blockResults = await Promise.all(\n      regions.map(region => {\n        const { refName, start, end } = region\n        const chrId = this.refNameToId(refName)\n        return cram.index.getEntriesForRange(chrId, start, end)\n      }),\n    )\n\n    return blockResults.flat().reduce((a, b) => a + b.sliceBytes, 0)\n  }\n}\n"],"names":["CramSlightlyLazyFeature","record","_store","this","readName","alignmentStart","lengthOnRef","readFeatures","mappingQuality","flags","isReverseComplemented","rg","samHeader","readGroups","readGroupId","undefined","qualityScores","join","refIdToName","sequenceId","_get_seq_id","mate","isPaired","getPairOrientation","templateLength","templateSize","RG","_read_group_id","tags","getReadBases","seq","cigar","op","oplen","ref","_refRegion","refStart","start","last_pos","sublen","forEach","code","refPos","sub","data","substring","ret","split","added","String","fromCharCode","length","readLength","Object","getOwnPropertyNames","prototype","filter","prop","startsWith","map","methodName","replace","id","uniqueId","field","mismatches","get","type","cliplen","t","val","name","qual","qualRaw","args","pos","push","base","altbase","len","CramAdapter","setupP","seqIdToRefName","seqIdToOriginalRefName","cramLocation","getConf","craiLocation","Error","cram","IndexedCramFile","cramFilehandle","openLocation","pluginManager","index","CraiIndex","filehandle","seqFetch","bind","checkSequenceMD5","fetchSizeLimit","sequenceAdapterType","getSubAdapter","seqConf","sequenceAdapter","dataAdapter","BaseFeatureDataAdapter","opts","configure","getHeaderText","seqId","end","refName","refIdToOriginalName","getFeatures","assemblyName","pipe","toArray","toPromise","seqChunks","sequence","sort","a","b","chunk","chunkStart","chunkEnd","trimStart","Math","max","trimLength","min","substr","toLocaleString","statusCallback","configured","getSamHeader","signal","idToName","nameToId","l","tag","sqLine","refId","item","value","rgLine","find","setupPre","catch","e","setup","indexOf","region","filterBy","originalRefName","ObservableCreate","observer","getRefNames","refNameToId","getRecordsForRange","records","checkAbortSignal","flagInclude","flagExclude","tagFilter","filtered","next","cramRecordToFeature","console","warn","complete","regions","bytesForRegions","bytes","_opts","Promise","all","chrId","getEntriesForRange","blockResults","flat","reduce","sliceBytes"],"sourceRoot":""}