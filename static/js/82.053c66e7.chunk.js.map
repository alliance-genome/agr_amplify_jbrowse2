{"version":3,"sources":["../../../plugins/wiggle/src/BigWigAdapter/BigWigAdapter.ts"],"names":["BigWigAdapter","config","getSubAdapter","pluginManager","bigwig","BigWig","filehandle","openLocation","readConfObject","opts","statusCallback","updateStatus","getHeader","this","setup","refsByName","Object","keys","refId","refsByNumber","name","totalSummary","rectifyStats","region","refName","start","end","bpPerPx","signal","resolution","ObservableCreate","observer","a","getFeatureStream","basesPerSpan","pipe","mergeAll","map","record","SimpleFeature","id","data","subscribe","_regions","featureDensity","BaseFeatureDataAdapter","capabilities"],"mappings":"kUAsBqBA,E,kDASnB,WACEC,EACAC,EACAC,GACA,kCACA,cAAMF,EAAQC,EAAeC,IAbvBC,YAYN,EAEA,EAAKA,OAAS,IAAIC,SAAO,CACvBC,WAAYC,uBACVC,yBAAeP,EAAQ,kBACvB,EAAKE,iBALT,E,gFAUF,WAAoBM,GAApB,0FACwCA,GAAQ,IAAtCC,sBADV,MAC2B,aAD3B,oBAESC,uBAAa,4BAA6BD,GAAgB,kBAC/D,EAAKN,OAAOQ,UAAUH,OAH1B,2C,uHAOA,WAAyBA,GAAzB,yFAC+BI,KAAKC,MAAML,GAD1C,uBACUM,EADV,EACUA,WADV,kBAESC,OAAOC,KAAKF,IAFrB,gD,uHAKA,WAAyBG,GAAzB,2FACiCL,KAAKC,QADtC,uBACUK,EADV,EACUA,aADV,4BAESA,EAAaD,UAFtB,aAES,EAAqBE,MAF9B,gD,0HAKA,WAA4BX,GAA5B,yFACiCI,KAAKC,MAAML,GAD5C,uBACUY,EADV,EACUA,aADV,kBAESC,YAAaD,IAFtB,gD,gFAKA,SAAmBE,GAA0C,WAA1Bd,EAA0B,uDAAJ,GAC/Ce,EAAwBD,EAAxBC,QAASC,EAAeF,EAAfE,MAAOC,EAAQH,EAARG,IACxB,EAKIjB,EAJFkB,eADF,MACY,EADZ,EAEEC,EAGEnB,EAHFmB,OAFF,EAKInB,EAFFoB,kBAHF,MAGe,EAHf,IAKIpB,EADFC,sBAJF,MAImB,aAJnB,EAMA,OAAOoB,2BAAgB,uCAAU,WAAMC,GAAN,SAAAC,EAAA,6DAC/BtB,EAAe,2BADgB,SAEd,EAAKN,OAAO6B,iBAAiBT,EAASC,EAAOC,EAA7C,2BACZjB,GADY,IAEfyB,aAAcP,EAAUE,KAJK,cAM5BM,KACDC,cACAC,aAAI,SAAAC,GACF,OAAO,IAAIC,IAAc,CACvBC,GAAI,GAAF,OAAKhB,EAAL,YAAgBc,EAAOb,MAAvB,YAAgCa,EAAOZ,KACzCe,KAAM,2BAAKH,GAAP,IAAed,kBAGvBkB,UAAUX,GAdmB,2CAAV,sDAepBH,K,yEAIL,WAA2Be,GAA3B,SAAAX,EAAA,+EACS,CAAEY,eAAgB,IAD3B,2C,kFAIA,gB,GA5EyCC,0BAAtB7C,EAGL8C,aAAe,CAC3B,gBACA,gBACA","file":"static/js/82.053c66e7.chunk.js","sourcesContent":["import { BigWig } from '@gmod/bbi'\nimport {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { AugmentedRegion as Region } from '@jbrowse/core/util/types'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { updateStatus } from '@jbrowse/core/util'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport SimpleFeature, { Feature } from '@jbrowse/core/util/simpleFeature'\nimport { map, mergeAll } from 'rxjs/operators'\nimport { readConfObject } from '@jbrowse/core/configuration'\nimport { AnyConfigurationModel } from '@jbrowse/core/configuration/configurationSchema'\nimport { rectifyStats, UnrectifiedFeatureStats } from '@jbrowse/core/util/stats'\nimport PluginManager from '@jbrowse/core/PluginManager'\n\nimport { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\n\ninterface WiggleOptions extends BaseOptions {\n  resolution?: number\n}\n\nexport default class BigWigAdapter extends BaseFeatureDataAdapter {\n  private bigwig: BigWig\n\n  public static capabilities = [\n    'hasResolution',\n    'hasLocalStats',\n    'hasGlobalStats',\n  ]\n\n  public constructor(\n    config: AnyConfigurationModel,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    this.bigwig = new BigWig({\n      filehandle: openLocation(\n        readConfObject(config, 'bigWigLocation'),\n        this.pluginManager,\n      ),\n    })\n  }\n\n  private async setup(opts?: BaseOptions) {\n    const { statusCallback = () => {} } = opts || {}\n    return updateStatus('Downloading bigwig header', statusCallback, () =>\n      this.bigwig.getHeader(opts),\n    )\n  }\n\n  public async getRefNames(opts?: BaseOptions) {\n    const { refsByName } = await this.setup(opts)\n    return Object.keys(refsByName)\n  }\n\n  public async refIdToName(refId: number) {\n    const { refsByNumber } = await this.setup()\n    return refsByNumber[refId]?.name\n  }\n\n  public async getGlobalStats(opts?: BaseOptions) {\n    const { totalSummary } = await this.setup(opts)\n    return rectifyStats(totalSummary as UnrectifiedFeatureStats)\n  }\n\n  public getFeatures(region: Region, opts: WiggleOptions = {}) {\n    const { refName, start, end } = region\n    const {\n      bpPerPx = 0,\n      signal,\n      resolution = 1,\n      statusCallback = () => {},\n    } = opts\n    return ObservableCreate<Feature>(async observer => {\n      statusCallback('Downloading bigwig data')\n      const ob = await this.bigwig.getFeatureStream(refName, start, end, {\n        ...opts,\n        basesPerSpan: bpPerPx / resolution,\n      })\n      ob.pipe(\n        mergeAll(),\n        map(record => {\n          return new SimpleFeature({\n            id: `${refName}:${record.start}-${record.end}`,\n            data: { ...record, refName },\n          })\n        }),\n      ).subscribe(observer)\n    }, signal)\n  }\n\n  // always render bigwig instead of calculating a feature density for it\n  async estimateRegionsStats(_regions: Region[]) {\n    return { featureDensity: 0 }\n  }\n\n  public freeResources(): void {}\n}\n"],"sourceRoot":""}