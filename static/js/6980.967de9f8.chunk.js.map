{"version":3,"file":"static/js/6980.967de9f8.chunk.js","mappings":"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","sources":["../../../plugins/variants/src/VcfAdapter/VcfAdapter.ts"],"sourcesContent":["import {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { Region, Feature } from '@jbrowse/core/util'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport IntervalTree from '@flatten-js/interval-tree'\nimport { unzip } from '@gmod/bgzf-filehandle'\nimport VCF from '@gmod/vcf'\n\n// local\nimport VcfFeature from '../VcfFeature'\n\nconst readVcf = (f: string) => {\n  const header: string[] = []\n  const rest: string[] = []\n  f.split(/\\n|\\r\\n|\\r/)\n    .map(f => f.trim())\n    .filter(f => !!f)\n    .forEach(line => {\n      if (line.startsWith('#')) {\n        header.push(line)\n      } else if (line) {\n        rest.push(line)\n      }\n    })\n  return { header: header.join('\\n'), lines: rest }\n}\n\nfunction isGzip(buf: Buffer) {\n  return buf[0] === 31 && buf[1] === 139 && buf[2] === 8\n}\n\nexport default class VcfAdapter extends BaseFeatureDataAdapter {\n  public static capabilities = ['getFeatures', 'getRefNames']\n\n  protected vcfFeatures?: Promise<{\n    header: string\n    intervalTree: Record<string, IntervalTree>\n  }>\n\n  public async getHeader() {\n    const { header } = await this.setup()\n    return header\n  }\n\n  async getMetadata() {\n    const { header } = await this.setup()\n    const parser = new VCF({ header: header })\n    return parser.getMetadata()\n  }\n\n  // converts lines into an interval tree\n  public async setupP() {\n    const pm = this.pluginManager\n    const buf = await openLocation(this.getConf('vcfLocation'), pm).readFile()\n\n    const buffer = isGzip(buf) ? await unzip(buf) : buf\n\n    // 512MB  max chrome string length is 512MB\n    if (buffer.length > 536_870_888) {\n      throw new Error('Data exceeds maximum string length (512MB)')\n    }\n\n    const str = new TextDecoder().decode(buffer)\n    const { header, lines } = readVcf(str)\n\n    const intervalTree = lines\n      .map((line, id) => {\n        const [refName, startP, , ref, , , , info] = line.split('\\t')\n        const start = +startP - 1\n        const end = +(info.match(/END=(\\d+)/)?.[1].trim() || start + ref.length)\n        return { line, refName, start, end, id }\n      })\n      .reduce((acc, obj) => {\n        const key = obj.refName\n        if (!acc[key]) {\n          acc[key] = new IntervalTree()\n        }\n        acc[key].insert([obj.start, obj.end], obj)\n        return acc\n      }, {} as Record<string, IntervalTree>)\n\n    return { header, intervalTree }\n  }\n\n  public async setup() {\n    if (!this.vcfFeatures) {\n      this.vcfFeatures = this.setupP().catch(e => {\n        this.vcfFeatures = undefined\n        throw e\n      })\n    }\n    return this.vcfFeatures\n  }\n\n  public async getRefNames(_: BaseOptions = {}) {\n    const { intervalTree } = await this.setup()\n    return Object.keys(intervalTree)\n  }\n\n  public getFeatures(region: Region, opts: BaseOptions = {}) {\n    return ObservableCreate<Feature>(async observer => {\n      try {\n        const { start, end, refName } = region\n        const { header, intervalTree } = await this.setup()\n        const parser = new VCF({ header })\n        intervalTree[refName]?.search([start, end]).forEach(f =>\n          observer.next(\n            new VcfFeature({\n              variant: parser.parseLine(f.line),\n              parser,\n              id: `${this.id}-${f.id}`,\n            }),\n          ),\n        )\n        observer.complete()\n      } catch (e) {\n        observer.error(e)\n      }\n    }, opts.signal)\n  }\n\n  public freeResources(): void {}\n}\n"],"names":["readVcf","f","header","rest","split","map","trim","filter","forEach","line","startsWith","push","join","lines","isGzip","buf","VcfAdapter","_BaseFeatureDataAdapt","_inherits","_super","_createSuper","_this","_classCallCheck","_len","arguments","length","args","Array","_key","call","apply","concat","vcfFeatures","_createClass","key","value","_getHeader","_asyncToGenerator","_regeneratorRuntime","mark","_callee","_yield$this$setup","wrap","_context","prev","next","this","setup","sent","abrupt","stop","_getMetadata","_callee2","_yield$this$setup2","parser","_context2","VCF","getMetadata","_setupP","_callee3","pm","buffer","str","_readVcf","intervalTree","_context3","pluginManager","openLocation","getConf","readFile","unzip","t0","Error","TextDecoder","decode","id","_info$match","_line$split","_line$split2","_slicedToArray","refName","startP","ref","start","end","match","reduce","acc","obj","IntervalTree","insert","_setup","_callee4","_this2","_context4","setupP","catch","e","undefined","_getRefNames","_callee5","_yield$this$setup3","_args5","_context5","Object","keys","region","_this3","opts","ObservableCreate","_ref","_callee6","observer","_intervalTree$refName","_yield$_this3$setup","_context6","search","VcfFeature","variant","parseLine","complete","error","_x","signal","BaseFeatureDataAdapter","capabilities"],"sourceRoot":""}