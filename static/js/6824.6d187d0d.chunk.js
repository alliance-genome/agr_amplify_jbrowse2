"use strict";(self.webpackChunk_jbrowse_web=self.webpackChunk_jbrowse_web||[]).push([[6824],{16824:function(e,t,r){r.r(t),r.d(t,{default:function(){return S}});var n=r(41361),a=r(34795),i=r(9249),u=r(87371),s=r(93069),c=r(95058),o=r(45754),f=r(86906),d=r(77162),h=r.n(d),p=r(77431),l=r(29598),g=r(81073),v=r(33528),m=r(26131),_=r(26080),k=r(9077),b=r(33028),y=r(68079),x=r(99703),w=function(){function e(t,r,n){(0,i.Z)(this,e),this.record=t,this.adapter=r,this.ref=n}return(0,u.Z)(e,[{key:"_get_name",value:function(){return this.record.get("name")}},{key:"_get_type",value:function(){return"match"}},{key:"_get_score",value:function(){return this.record.get("mq")}},{key:"_get_flags",value:function(){return this.record.flags}},{key:"_get_strand",value:function(){return this.record.isReverseComplemented()?-1:1}},{key:"_get_pair_orientation",value:function(){return this.record.isPaired()?this.record.getPairOrientation():void 0}},{key:"_get_next_seq_id",value:function(){return this.record._next_refid()}},{key:"_get_seq_id",value:function(){return this.record._refID}},{key:"_get_next_refName",value:function(){return this.adapter.refIdToName(this.record._next_refid())}},{key:"_get_next_segment_position",value:function(){var e=this.record,t=this.adapter;return e.isPaired()?"".concat(t.refIdToName(e._next_refid()),":").concat(e._next_pos()+1):void 0}},{key:"_get_seq",value:function(){return this.record.getReadBases()}},{key:"qualRaw",value:function(){return this.record.qualRaw()}},{key:"set",value:function(){}},{key:"tags",value:function(){var t=Object.getOwnPropertyNames(e.prototype);return(0,y.Z)(new Set(t.filter((function(e){return e.startsWith("_get_")&&"_get_mismatches"!==e&&"_get_tags"!==e&&"_get_next_seq_id"!==e&&"_get_seq_id"!==e})).map((function(e){return e.replace("_get_","")})).concat(this.record._tags())))}},{key:"id",value:function(){return"".concat(this.adapter.id,"-").concat(this.record.id())}},{key:"get",value:function(e){var t="_get_".concat(e);return this[t]?this[t]():this.record.get(e)}},{key:"_get_refName",value:function(){return this.adapter.refIdToName(this.record.seq_id())}},{key:"parent",value:function(){}},{key:"children",value:function(){}},{key:"pairedFeature",value:function(){return!1}},{key:"toJSON",value:function(){var e=this;return(0,b.Z)((0,b.Z)({},Object.fromEntries(this.tags().map((function(t){return[t,e.get(t)]})).filter((function(e){return void 0!==e[1]})))),{},{uniqueId:this.id()})}},{key:"_get_mismatches",value:function(){return(0,x.getMismatches)(this.get("CIGAR"),this.get("MD"),this.get("seq"),this.ref,this.qualRaw())}},{key:"_get_clipPos",value:function(){var e=this.get("CIGAR")||"";return-1===this.get("strand")?+(e.match(/(\d+)[SH]$/)||[])[1]||0:+(e.match(/^(\d+)([SH])/)||[])[1]||0}}]),e}(),S=function(e){(0,o.Z)(r,e);var t=(0,f.Z)(r);function r(){var e;(0,i.Z)(this,r);for(var n=arguments.length,a=new Array(n),u=0;u<n;u++)a[u]=arguments[u];return(e=t.call.apply(t,[this].concat(a))).samHeader=void 0,e.setupP=void 0,e.configured=void 0,e}return(0,u.Z)(r,[{key:"configure",value:function(){var e=(0,a.Z)(h().mark((function e(){var t,r,n,a,i;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.configured||(t=(0,k.readConfObject)(this.config,"bamLocation"),r=(0,k.readConfObject)(this.config,["index","location"]),n=(0,k.readConfObject)(this.config,["index","indexType"]),a=new p.$({bamFilehandle:(0,v.openLocation)(t,this.pluginManager),csiFilehandle:"CSI"===n?(0,v.openLocation)(r,this.pluginManager):void 0,baiFilehandle:"CSI"!==n?(0,v.openLocation)(r,this.pluginManager):void 0,chunkSizeLimit:1/0,fetchSizeLimit:1/0,yieldThreadTime:1/0}),(i=(0,k.readConfObject)(this.config,"sequenceAdapter"))&&this.getSubAdapter?this.configured=this.getSubAdapter(i).then((function(e){var t=e.dataAdapter;return{bam:a,sequenceAdapter:t}})):this.configured=Promise.resolve({bam:a})),e.abrupt("return",this.configured);case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getHeader",value:function(){var e=(0,a.Z)(h().mark((function e(t){var r,n;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:return r=e.sent,n=r.bam,e.abrupt("return",n.getHeaderText(t));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setupPre",value:function(){var e=(0,a.Z)(h().mark((function e(t){var r,n,i,u;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(t||{}).statusCallback,n=void 0===r?function(){}:r,e.next=3,this.configure();case 3:return i=e.sent,u=i.bam,e.next=7,(0,g.updateStatus)("Downloading index",n,(0,a.Z)(h().mark((function e(){var r,n,a;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,u.getHeader(t);case 2:return r=e.sent,n=[],a={},r.filter((function(e){return"SQ"===e.tag})).forEach((function(e,t){e.data.forEach((function(e){if("SN"===e.tag){var r=e.value;a[r]=t,n[t]=r}}))})),e.abrupt("return",{idToName:n,nameToId:a});case 7:case"end":return e.stop()}}),e)}))));case 7:return this.samHeader=e.sent,e.abrupt("return",this.samHeader);case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setup",value:function(){var e=(0,a.Z)(h().mark((function e(t){var r=this;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setupP||(this.setupP=this.setupPre(t).catch((function(e){throw r.setupP=void 0,e}))),e.abrupt("return",this.setupP);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getRefNames",value:function(){var e=(0,a.Z)(h().mark((function e(t){var r,n;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.setup(t);case 2:return r=e.sent,n=r.idToName,e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"seqFetch",value:function(){var e=(0,a.Z)(h().mark((function e(t,r,n){var a,i,u,s,c,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:if(a=e.sent,i=a.sequenceAdapter,u=i){e.next=7;break}return e.abrupt("return",void 0);case 7:if(t){e.next=9;break}return e.abrupt("return",void 0);case 9:return s=u.getFeatures({refName:t,start:r,end:n,assemblyName:""}),e.next=12,s.pipe((0,_.q)()).toPromise();case 12:if(c=e.sent,o="",c.sort((function(e,t){return e.get("start")-t.get("start")})).forEach((function(e){var t=e.get("start"),a=e.get("end"),i=Math.max(r-t,0),u=Math.min(n-t,a-t)-i,s=e.get("seq")||e.get("residues");o+=s.substr(i,u)})),o.length===n-r){e.next=17;break}throw new Error("sequence fetch failed: fetching ".concat(t,":").concat((r-1).toLocaleString(),"-").concat(n.toLocaleString()," returned ").concat(o.length.toLocaleString()," bases, but should have returned ").concat((n-r).toLocaleString()));case 17:return e.abrupt("return",o);case 18:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"getFeatures",value:function(e,t){var r=this,i=e.refName,u=e.start,s=e.end,c=e.originalRefName,o=t||{},f=o.signal,d=o.filterBy,p=o.statusCallback,l=void 0===p?function(){}:p;return(0,m.ObservableCreate)(function(){var e=(0,a.Z)(h().mark((function e(a){var o,f,p,g,v,m,_,k,b,y,x,S,Z,q,N,C;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.configure();case 2:return o=e.sent,f=o.bam,e.next=6,r.setup(t);case 6:return l("Downloading alignments"),e.next=9,f.getRecordsForRange(i,u,s,t);case 9:p=e.sent,v=(g=d||{}).flagInclude,m=void 0===v?0:v,_=g.flagExclude,k=void 0===_?0:_,b=g.tagFilter,y=g.name,x=(0,n.Z)(p),e.prev=12,x.s();case 14:if((S=x.n()).done){e.next=33;break}if(Z=S.value,q=void 0,Z.get("MD")){e.next=21;break}return e.next=20,r.seqFetch(c||i,Z.get("start"),Z.get("end"));case 20:q=e.sent;case 21:if(((N=Z.flags)&m)===m&&!(N&k)){e.next=24;break}return e.abrupt("continue",31);case 24:if(!b){e.next=28;break}if("*"===(C=Z.get(b.tag))?void 0!==C:C===b.value){e.next=28;break}return e.abrupt("continue",31);case 28:if(!y||Z.get("name")===y){e.next=30;break}return e.abrupt("continue",31);case 30:a.next(new w(Z,r,q));case 31:e.next=14;break;case 33:e.next=38;break;case 35:e.prev=35,e.t0=e.catch(12),x.e(e.t0);case 38:return e.prev=38,x.f(),e.finish(38);case 41:l(""),a.complete();case 43:case"end":return e.stop()}}),e,null,[[12,35,38,41]])})));return function(t){return e.apply(this,arguments)}}(),f)}},{key:"estimateRegionsStats",value:function(){var e=(0,a.Z)(h().mark((function e(t,n){var a,i,u,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:if(a=e.sent,"?"===(i=a.bam).index.filehandle){e.next=12;break}return e.next=7,(0,g.bytesForRegions)(t,i);case 7:return u=e.sent,o=(0,k.readConfObject)(this.config,"fetchSizeLimit"),e.abrupt("return",{bytes:u,fetchSizeLimit:o});case 12:return e.abrupt("return",(0,s.Z)((0,c.Z)(r.prototype),"estimateRegionsStats",this).call(this,t,n));case 13:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"freeResources",value:function(){}},{key:"refIdToName",value:function(e){var t;return null===(t=this.samHeader)||void 0===t?void 0:t.idToName[e]}}]),r}(l.BaseFeatureDataAdapter)}}]);
//# sourceMappingURL=6824.6d187d0d.chunk.js.map