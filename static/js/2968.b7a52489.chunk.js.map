{"version":3,"file":"static/js/2968.b7a52489.chunk.js","mappings":"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","sources":["../../../plugins/gff3/src/Gff3TabixAdapter/Gff3TabixAdapter.ts"],"sourcesContent":["/* eslint-disable no-underscore-dangle */\nimport {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { doesIntersect2 } from '@jbrowse/core/util/range'\nimport { Region } from '@jbrowse/core/util/types'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport SimpleFeature, { Feature } from '@jbrowse/core/util/simpleFeature'\nimport { TabixIndexedFile } from '@gmod/tabix'\nimport gff, { GFF3Feature, GFF3FeatureLineWithRefs } from '@gmod/gff'\nimport { Observer } from 'rxjs'\nimport {\n  readConfObject,\n  AnyConfigurationModel,\n} from '@jbrowse/core/configuration'\nimport PluginManager from '@jbrowse/core/PluginManager'\nimport { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\n\ninterface LineFeature {\n  start: number\n  end: number\n  lineHash: number\n  fields: string[]\n}\n\nexport default class extends BaseFeatureDataAdapter {\n  protected gff: TabixIndexedFile\n\n  protected dontRedispatch: string[]\n\n  public constructor(\n    config: AnyConfigurationModel,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    const gffGzLocation = readConfObject(config, 'gffGzLocation')\n    const indexType = readConfObject(config, ['index', 'indexType'])\n    const location = readConfObject(config, ['index', 'location'])\n    const dontRedispatch = readConfObject(config, 'dontRedispatch')\n\n    this.dontRedispatch = dontRedispatch || ['chromosome', 'contig', 'region']\n    this.gff = new TabixIndexedFile({\n      filehandle: openLocation(gffGzLocation, this.pluginManager),\n      csiFilehandle:\n        indexType === 'CSI'\n          ? openLocation(location, this.pluginManager)\n          : undefined,\n      tbiFilehandle:\n        indexType !== 'CSI'\n          ? openLocation(location, this.pluginManager)\n          : undefined,\n      chunkCacheSize: 50 * 2 ** 20,\n      renameRefSeqs: (n: string) => n,\n    })\n  }\n\n  public async getRefNames(opts: BaseOptions = {}) {\n    return this.gff.getReferenceSequenceNames(opts)\n  }\n\n  public async getHeader() {\n    return this.gff.getHeader()\n  }\n\n  public getFeatures(query: Region, opts: BaseOptions = {}) {\n    return ObservableCreate<Feature>(async observer => {\n      const metadata = await this.gff.getMetadata()\n      await this.getFeaturesHelper(query, opts, metadata, observer, true)\n    }, opts.signal)\n  }\n\n  private async getFeaturesHelper(\n    query: Region,\n    opts: BaseOptions = {},\n    metadata: { columnNumbers: { start: number; end: number } },\n    observer: Observer<Feature>,\n    allowRedispatch: boolean,\n    originalQuery = query,\n  ) {\n    try {\n      const lines: LineFeature[] = []\n\n      await this.gff.getLines(\n        query.refName,\n        query.start,\n        query.end,\n        (line: string, fileOffset: number) => {\n          lines.push(this.parseLine(metadata.columnNumbers, line, fileOffset))\n        },\n      )\n      if (allowRedispatch && lines.length) {\n        let minStart = Infinity\n        let maxEnd = -Infinity\n        lines.forEach(line => {\n          const featureType = line.fields[2]\n          // only expand redispatch range if feature is not a \"dontRedispatch\" type\n          // skips large regions like chromosome,region\n          if (!this.dontRedispatch.includes(featureType)) {\n            const start = line.start - 1 // gff is 1-based\n            if (start < minStart) {\n              minStart = start\n            }\n            if (line.end > maxEnd) {\n              maxEnd = line.end\n            }\n          }\n        })\n        if (maxEnd > query.end || minStart < query.start) {\n          // make a new feature callback to only return top-level features\n          // in the original query range\n          await this.getFeaturesHelper(\n            { ...query, start: minStart, end: maxEnd },\n            opts,\n            metadata,\n            observer,\n            false,\n            query,\n          )\n          return\n        }\n      }\n\n      const gff3 = lines\n        .map((lineRecord: LineFeature) => {\n          if (lineRecord.fields[8] && lineRecord.fields[8] !== '.') {\n            if (!lineRecord.fields[8].includes('_lineHash')) {\n              lineRecord.fields[8] += `;_lineHash=${lineRecord.lineHash}`\n            }\n          } else {\n            lineRecord.fields[8] = `_lineHash=${lineRecord.lineHash}`\n          }\n          return lineRecord.fields.join('\\t')\n        })\n        .join('\\n')\n\n      const features = gff.parseStringSync(gff3, {\n        parseFeatures: true,\n        parseComments: false,\n        parseDirectives: false,\n        parseSequences: false,\n        disableDerivesFromReferences: true,\n      })\n\n      features.forEach(featureLocs =>\n        this.formatFeatures(featureLocs).forEach(f => {\n          if (\n            doesIntersect2(\n              f.get('start'),\n              f.get('end'),\n              originalQuery.start,\n              originalQuery.end,\n            )\n          ) {\n            observer.next(f)\n          }\n        }),\n      )\n      observer.complete()\n    } catch (e) {\n      observer.error(e)\n    }\n  }\n\n  private parseLine(\n    columnNumbers: { start: number; end: number },\n    line: string,\n    fileOffset: number,\n  ) {\n    const fields = line.split('\\t')\n\n    // note: index column numbers are 1-based\n    return {\n      start: +fields[columnNumbers.start - 1],\n      end: +fields[columnNumbers.end - 1],\n      lineHash: fileOffset,\n      fields,\n    }\n  }\n\n  private formatFeatures(featureLocs: GFF3Feature) {\n    return featureLocs.map(\n      featureLoc =>\n        new SimpleFeature({\n          data: this.featureData(featureLoc),\n          // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n          id: `${this.id}-offset-${featureLoc.attributes!._lineHash![0]}`,\n        }),\n    )\n  }\n\n  private featureData(data: GFF3FeatureLineWithRefs) {\n    const f: Record<string, unknown> = { ...data }\n    ;(f.start as number) -= 1 // convert to interbase\n    if (data.strand === '+') {\n      f.strand = 1\n    } else if (data.strand === '-') {\n      f.strand = -1\n    } else if (data.strand === '.') {\n      f.strand = 0\n    } else {\n      f.strand = undefined\n    }\n    f.phase = Number(data.phase)\n    f.refName = data.seq_id\n    if (data.score === null) {\n      delete f.score\n    }\n    if (data.phase === null) {\n      delete f.score\n    }\n    const defaultFields = [\n      'start',\n      'end',\n      'seq_id',\n      'score',\n      'type',\n      'source',\n      'phase',\n      'strand',\n    ]\n    const dataAttributes = data.attributes || {}\n    Object.keys(dataAttributes).forEach(a => {\n      let b = a.toLowerCase()\n      if (defaultFields.includes(b)) {\n        // add \"suffix\" to tag name if it already exists\n        // reproduces behavior of NCList\n        b += '2'\n      }\n      if (dataAttributes[a] !== null) {\n        let attr: string | string[] | undefined = dataAttributes[a]\n        if (Array.isArray(attr) && attr.length === 1) {\n          ;[attr] = attr\n        }\n        f[b] = attr\n      }\n    })\n    f.refName = f.seq_id\n\n    // the SimpleFeature constructor takes care of recursively inflating subfeatures\n    if (data.child_features && data.child_features.length) {\n      f.subfeatures = data.child_features\n        .map(childLocs => childLocs.map(childLoc => this.featureData(childLoc)))\n        .flat()\n    }\n\n    delete f.child_features\n    delete f.data\n    // delete f.derived_features\n    delete f._linehash\n    delete f.attributes\n    delete f.seq_id\n\n    return f\n  }\n\n  public freeResources(/* { region } */) {}\n}\n"],"names":["_default","_BaseFeatureDataAdapt","_inherits","_super","_createSuper","config","getSubAdapter","pluginManager","_this","_classCallCheck","call","gff","dontRedispatch","gffGzLocation","readConfObject","indexType","location","TabixIndexedFile","filehandle","openLocation","csiFilehandle","undefined","tbiFilehandle","chunkCacheSize","Math","pow","renameRefSeqs","n","_createClass","key","value","_getRefNames","_asyncToGenerator","_regeneratorRuntime","mark","_callee","opts","_args","arguments","wrap","_context","prev","next","length","abrupt","this","getReferenceSequenceNames","stop","apply","_getHeader","_callee2","_context2","getHeader","query","_this2","ObservableCreate","_ref","_callee3","observer","metadata","_context3","getMetadata","sent","getFeaturesHelper","_x","signal","_getFeaturesHelper","_callee4","allowRedispatch","originalQuery","lines","minStart","maxEnd","gff3","_this3","_args4","_context4","getLines","refName","start","end","line","fileOffset","push","parseLine","columnNumbers","Infinity","forEach","featureType","fields","includes","_objectSpread","map","lineRecord","concat","lineHash","join","parseFeatures","parseComments","parseDirectives","parseSequences","disableDerivesFromReferences","featureLocs","formatFeatures","f","doesIntersect2","get","complete","t0","error","_x2","split","_this4","featureLoc","SimpleFeature","data","featureData","id","attributes","_lineHash","_this5","strand","phase","Number","seq_id","score","defaultFields","dataAttributes","Object","keys","a","b","toLowerCase","attr","Array","isArray","_attr","_slicedToArray","child_features","subfeatures","childLocs","childLoc","flat","_linehash","BaseFeatureDataAdapter"],"sourceRoot":""}