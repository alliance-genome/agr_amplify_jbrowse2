{"version":3,"file":"static/js/8930.357a4852.chunk.js","mappings":"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","sources":["../../../plugins/variants/src/VcfAdapter/VcfAdapter.ts"],"sourcesContent":["import {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { Region } from '@jbrowse/core/util/types'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { Feature } from '@jbrowse/core/util/simpleFeature'\nimport { readConfObject } from '@jbrowse/core/configuration'\nimport IntervalTree from '@flatten-js/interval-tree'\nimport { unzip } from '@gmod/bgzf-filehandle'\nimport VCF from '@gmod/vcf'\nimport VcfFeature from '../VcfTabixAdapter/VcfFeature'\n\nconst readVcf = (f: string) => {\n  const lines = f.split('\\n')\n  const header: string[] = []\n  const rest: string[] = []\n  lines.forEach(line => {\n    if (line.startsWith('#')) {\n      header.push(line)\n    } else if (line) {\n      rest.push(line)\n    }\n  })\n  return { header: header.join('\\n'), lines: rest }\n}\n\nfunction isGzip(buf: Buffer) {\n  return buf[0] === 31 && buf[1] === 139 && buf[2] === 8\n}\n\nexport default class VcfAdapter extends BaseFeatureDataAdapter {\n  public static capabilities = ['getFeatures', 'getRefNames']\n\n  protected vcfFeatures?: Promise<{\n    header: string\n    intervalTree: Record<string, IntervalTree>\n  }>\n\n  public async getHeader() {\n    const { header } = await this.setup()\n    return header\n  }\n\n  async getMetadata() {\n    const { header } = await this.setup()\n    const parser = new VCF({ header: header })\n    return parser.getMetadata()\n  }\n\n  // converts lines into an interval tree\n  public async setupP() {\n    const buffer = await openLocation(\n      readConfObject(this.config, 'vcfLocation'),\n      this.pluginManager,\n    ).readFile()\n\n    const buf = isGzip(buffer) ? await unzip(buffer) : buffer\n\n    // 512MB  max chrome string length is 512MB\n    if (buf.length > 536_870_888) {\n      throw new Error('Data exceeds maximum string length (512MB)')\n    }\n\n    const str = new TextDecoder().decode(buf)\n    const { header, lines } = readVcf(str)\n\n    const intervalTree = lines\n      .map((line, id) => {\n        const [refName, startP, , ref, , , , info] = line.split('\\t')\n        const start = +startP - 1\n        const end = +(info.match(/END=(\\d+)/)?.[1].trim() || start + ref.length)\n        return { line, refName, start, end, id }\n      })\n      .reduce((acc, obj) => {\n        const key = obj.refName\n        if (!acc[key]) {\n          acc[key] = new IntervalTree()\n        }\n        acc[key].insert([obj.start, obj.end], obj)\n        return acc\n      }, {} as Record<string, IntervalTree>)\n\n    return { header, intervalTree }\n  }\n\n  public async setup() {\n    if (!this.vcfFeatures) {\n      this.vcfFeatures = this.setupP().catch(e => {\n        this.vcfFeatures = undefined\n        throw e\n      })\n    }\n    return this.vcfFeatures\n  }\n\n  public async getRefNames(_: BaseOptions = {}) {\n    const { intervalTree } = await this.setup()\n    return Object.keys(intervalTree)\n  }\n\n  public getFeatures(region: Region, opts: BaseOptions = {}) {\n    return ObservableCreate<Feature>(async observer => {\n      try {\n        const { start, end, refName } = region\n        const { header, intervalTree } = await this.setup()\n        const parser = new VCF({ header: header })\n        intervalTree[refName]?.search([start, end]).forEach(f =>\n          observer.next(\n            new VcfFeature({\n              variant: parser.parseLine(f.line),\n              parser,\n              id: `${this.id}-${f.id}`,\n            }),\n          ),\n        )\n        observer.complete()\n      } catch (e) {\n        observer.error(e)\n      }\n    }, opts.signal)\n  }\n\n  public freeResources(): void {}\n}\n"],"names":["readVcf","f","lines","split","header","rest","forEach","line","startsWith","push","join","isGzip","buf","VcfAdapter","vcfFeatures","this","setup","parser","VCF","getMetadata","openLocation","readConfObject","config","pluginManager","readFile","buffer","unzip","length","Error","str","TextDecoder","decode","intervalTree","map","id","refName","startP","ref","start","end","match","trim","reduce","acc","obj","key","IntervalTree","insert","setupP","catch","e","undefined","Object","keys","region","opts","ObservableCreate","observer","search","next","VcfFeature","variant","parseLine","complete","error","signal","BaseFeatureDataAdapter","capabilities"],"sourceRoot":""}