(self.webpackChunk_jbrowse_web=self.webpackChunk_jbrowse_web||[]).push([[6849],{86646:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return _}});var n=r(33028),a=r(32723),i=r(34795),s=r(9249),u=r(87371),o=r(45754),c=r(13820),f=r(66925),d=r(29598),h=r(81073),l=r(33528),g=r(26131),p=r(26080),v=r(68079),m=function(){function e(t,r){(0,s.Z)(this,e),this.record=t,this._store=r}return(0,u.Z)(e,[{key:"_get_name",value:function(){return this.record.readName}},{key:"_get_start",value:function(){return this.record.alignmentStart-1}},{key:"_get_end",value:function(){return this.record.alignmentStart+this.record.lengthOnRef-1}},{key:"_get_cram_read_features",value:function(){return this.record.readFeatures}},{key:"_get_type",value:function(){return"match"}},{key:"_get_score",value:function(){return this.record.mappingQuality}},{key:"_get_flags",value:function(){return this.record.flags}},{key:"_get_strand",value:function(){return this.record.isReverseComplemented()?-1:1}},{key:"_read_group_id",value:function(){var e=this._store.samHeader.readGroups;return e?e[this.record.readGroupId]:void 0}},{key:"_get_qual",value:function(){return(this.record.qualityScores||[]).join(" ")}},{key:"qualRaw",value:function(){return this.record.qualityScores}},{key:"_get_seq_id",value:function(){return this._store.refIdToName(this.record.sequenceId)}},{key:"_get_refName",value:function(){return this._get_seq_id()}},{key:"_get_is_paired",value:function(){return!!this.record.mate}},{key:"_get_pair_orientation",value:function(){return this.record.isPaired()?this.record.getPairOrientation():void 0}},{key:"_get_template_length",value:function(){return this.record.templateLength||this.record.templateSize}},{key:"_get_next_seq_id",value:function(){return this.record.mate?this._store.refIdToName(this.record.mate.sequenceId):void 0}},{key:"_get_next_pos",value:function(){return this.record.mate?this.record.mate.alignmentStart:void 0}},{key:"_get_next_segment_position",value:function(){return this.record.mate?"".concat(this._store.refIdToName(this.record.mate.sequenceId),":").concat(this.record.mate.alignmentStart):void 0}},{key:"_get_tags",value:function(){var e=this._read_group_id(),t=this.record.tags;return void 0!==e?(0,n.Z)((0,n.Z)({},t),{},{RG:e}):t}},{key:"_get_seq",value:function(){return this.record.getReadBases()}},{key:"_get_CIGAR",value:function(){var e="",t="",r="M",n=0,a=this.record._refRegion.seq,i=this.record._refRegion.start,s=this.record.alignmentStart,u=0;if("undefined"!==typeof this.record.readFeatures)for(var o=0;o<this.record.readFeatures.length;o++){var c=this.record.readFeatures[o],f=c.code,d=c.refPos,h=c.sub,l=c.data;if(u=d-s,e+=a.substring(s-i,d-i),s=d,n&&"M"!==r&&(t+=n+r,n=0),u&&(r="M",n+=u),"b"===f){var g=l.split(","),p=String.fromCharCode.apply(String,(0,v.Z)(g));e+=p,s+=p.length,n+=p.length}else"B"===f||"X"===f?(e+=h,s++,n++):"D"===f||"N"===f?(s+=l,n&&(t+=n+r),t+=l+f,n=0):"I"===f||"S"===f?(e+=l,n&&(t+=n+r),t+=l.length+f,n=0):"i"===f?(e+=l,n&&(t+=n+r),t+="".concat(1,"I"),n=0):"P"===f?(n&&(t+=n+r),t+="".concat(l,"P")):"H"===f&&(n&&(t+=n+r),t+="".concat(l,"H"),n=0)}else u=this.record.readLength-e.length;return e.length!==this.record.readLength&&(u=this.record.readLength-e.length,e+=a.substring(s-i,s-i+u),n&&"M"!==r&&(t+=n+r,n=0),r="M",n+=u),n&&(t+=n+r),t}},{key:"tags",value:function(){return Object.getOwnPropertyNames(e.prototype).filter((function(e){return e.startsWith("_get_")&&"_get_mismatches"!==e&&"_get_cram_read_features"!==e})).map((function(e){return e.replace("_get_","")}))}},{key:"id",value:function(){return"".concat(this._store.id,"-").concat(this.record.uniqueId)}},{key:"get",value:function(e){var t="_get_".concat(e);if(this[t])return this[t]()}},{key:"parent",value:function(){}},{key:"children",value:function(){}},{key:"set",value:function(){}},{key:"pairedFeature",value:function(){return!1}},{key:"_get_clipPos",value:function(){var e=this.get("mismatches");if(e.length){var t=-1===this.get("strand")?e[e.length-1]:e[0],r=t.type,n=t.cliplen;if("softclip"===r||"hardclip"===r)return n}return 0}},{key:"toJSON",value:function(){var e=this,t={};return this.tags().forEach((function(r){var n=e.get(r);void 0!==n&&(t[r]=n)})),(0,n.Z)((0,n.Z)({},t),{},{name:this.get("name"),type:this.get("type"),uniqueId:this.id()})}},{key:"_get_mismatches",value:function(){var e=this.get("cram_read_features"),t=this.qualRaw();if(!e)return[];for(var r=this.get("start"),n=new Array(e.length),a=0,i=0;i<e.length;i++){var s=e[i],u=s.code,o=s.pos,c=s.data,f=s.sub,d=s.ref,h=s.refPos-1-r;if("X"===u)n[a++]={start:h,length:1,base:f,qual:null===t||void 0===t?void 0:t[o],altbase:d,type:"mismatch"};else if("I"===u)n[a++]={start:h,type:"insertion",base:"".concat(c.length),length:0};else if("N"===u)n[a++]={type:"skip",length:c,start:h,base:"N"};else if("S"===u){var l=c.length;n[a++]={start:h,type:"softclip",base:"S".concat(l),cliplen:l,length:1}}else if("P"===u);else if("H"===u){var g=c;n[a++]={start:h,type:"hardclip",base:"H".concat(g),cliplen:g,length:1}}else"D"===u?n[a++]={type:"deletion",length:c,start:h,base:"*"}:"b"===u||"q"===u||"B"===u||"i"===u&&(n[a++]={start:h,type:"insertion",base:c,length:1})}return n.slice(0,a)}}]),e}(),_=function(e){(0,o.Z)(r,e);var t=(0,c.Z)(r);function r(){var e;(0,s.Z)(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return(e=t.call.apply(t,[this].concat(a))).samHeader={},e.setupP=void 0,e.seqIdToRefName=void 0,e.seqIdToOriginalRefName=[],e}return(0,u.Z)(r,[{key:"configure",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(){var t,r,n,i,s,u,o;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.getConf("cramLocation"),r=this.getConf("craiLocation"),t){e.next=4;break}throw new Error("missing cramLocation argument");case 4:if(r){e.next=6;break}throw new Error("missing craiLocation argument");case 6:if(n=new f.ED({cramFilehandle:(0,l.openLocation)(t,this.pluginManager),index:new f.lr({filehandle:(0,l.openLocation)(r,this.pluginManager)}),seqFetch:this.seqFetch.bind(this),checkSequenceMD5:!1,fetchSizeLimit:2e8}),i=this.getConf(["sequenceAdapter","type"]),this.getSubAdapter){e.next=10;break}throw new Error("Error getting subadapter");case 10:return s=this.getConf("sequenceAdapter"),e.next=13,this.getSubAdapter(s);case 13:if(u=e.sent,(o=u.dataAdapter)instanceof d.BaseFeatureDataAdapter){e.next=17;break}throw new Error("CRAM feature adapters cannot use sequence adapters of type '".concat(i,"'"));case 17:return e.abrupt("return",{cram:n,sequenceAdapter:o});case 18:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getHeader",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var r,n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:return r=e.sent,n=r.cram,e.abrupt("return",n.cram.getHeaderText(t));case 5:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"seqFetch",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r,n){var i,s,u,o,c;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r-=1,e.next=3,this.configure();case 3:if(i=e.sent,s=i.sequenceAdapter,u=this.refIdToOriginalName(t)||this.refIdToName(t)){e.next=8;break}return e.abrupt("return",void 0);case 8:return e.next=10,s.getFeatures({refName:u,start:r,end:n,assemblyName:""}).pipe((0,p.q)()).toPromise();case 10:if(o=e.sent,(c=o.sort((function(e,t){return e.get("start")-t.get("start")})).map((function(e){var t=e.get("start"),a=e.get("end"),i=Math.max(r-t,0),s=Math.min(n-t,a-t)-i;return(e.get("seq")||e.get("residues")).substr(i,s)})).join("")).length===n-r){e.next=14;break}throw new Error("sequence fetch failed: fetching ".concat(u,":").concat((r-1).toLocaleString(),"-").concat(n.toLocaleString()," returned ").concat(c.length.toLocaleString()," bases, but should have returned ").concat((n-r).toLocaleString()));case 14:return e.abrupt("return",c);case 15:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}()},{key:"setupPre",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var r,i,s,u,o,c,f,d,h;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(t||{}).statusCallback,i=void 0===r?function(){}:r,e.next=3,this.configure();case 3:return s=e.sent,i("Downloading index"),u=s.cram,e.next=8,u.cram.getSamHeader(null===t||void 0===t?void 0:t.signal);case 8:return o=e.sent,c=[],f={},o.filter((function(e){return"SQ"===e.tag})).forEach((function(e,t){e.data.forEach((function(e){if("SN"===e.tag){var r=e.value;f[r]=t,c[t]=r}}))})),d=o.filter((function(e){return"RG"===e.tag})).map((function(e){var t;return null===(t=e.data.find((function(e){return"ID"===e.tag})))||void 0===t?void 0:t.value})),h={idToName:c,nameToId:f,readGroups:d},i(""),this.samHeader=h,e.abrupt("return",(0,n.Z)({samHeader:h},s));case 17:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"setup",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var r=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setupP||(this.setupP=this.setupPre(t).catch((function(e){throw r.setupP=void 0,e}))),e.abrupt("return",this.setupP);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getRefNames",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t){var r,n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.setup(t);case 2:if(r=e.sent,(n=r.samHeader).idToName){e.next=6;break}throw new Error("CRAM file has no header lines");case 6:return e.abrupt("return",n.idToName);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"refNameToId",value:function(e){return this.samHeader.nameToId?this.samHeader.nameToId[e]:this.seqIdToRefName?this.seqIdToRefName.indexOf(e):void 0}},{key:"refIdToName",value:function(e){return this.samHeader.idToName?this.samHeader.idToName[e]:this.seqIdToRefName?this.seqIdToRefName[e]:void 0}},{key:"refIdToOriginalName",value:function(e){return this.seqIdToOriginalRefName[e]}},{key:"getFeatures",value:function(e,t){var r=this,n=t||{},s=n.signal,u=n.filterBy,o=n.statusCallback,c=void 0===o?function(){}:o,f=e.refName,d=e.start,l=e.end,p=e.originalRefName;return(0,g.ObservableCreate)(function(){var e=(0,i.Z)((0,a.Z)().mark((function e(n){var i,o,g,v,m,_,y,k,b,w,x,N,q;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.setup(t);case 2:if(i=e.sent,o=i.cram,g=i.sequenceAdapter,c("Downloading alignments"),r.seqIdToRefName){e.next=10;break}return e.next=9,g.getRefNames(t);case 9:r.seqIdToRefName=e.sent;case 10:if(void 0===(v=r.refNameToId(f))){e.next=24;break}return p&&(r.seqIdToOriginalRefName[v]=p),e.next=15,o.getRecordsForRange(v,d,l,t);case 15:m=e.sent,(0,h.checkAbortSignal)(s),y=(_=u||{}).flagInclude,k=void 0===y?0:y,b=_.flagExclude,w=void 0===b?0:b,x=_.tagFilter,N=_.readName,q=m.filter((function(e){var t=e.flags;return(t&k)===k&&!(t&w)})),x&&(q=q.filter((function(e){var t=e[x.tag];return"*"===t?void 0!==t:t===x.value}))),N&&(q=q.filter((function(e){return e.readName===N}))),q.forEach((function(e){n.next(r.cramRecordToFeature(e))})),e.next=25;break;case 24:console.warn("Unknown refName",f);case 25:c(""),n.complete();case 27:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),s)}},{key:"freeResources",value:function(){}},{key:"cramRecordToFeature",value:function(e){return new m(e,this)}},{key:"estimateRegionsStats",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r){var n,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.bytesForRegions(t,r);case 2:return n=e.sent,i=this.getConf("fetchSizeLimit"),e.abrupt("return",{bytes:n,fetchSizeLimit:i});case 5:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()},{key:"bytesForRegions",value:function(){var e=(0,i.Z)((0,a.Z)().mark((function e(t,r){var n,i,s,u=this;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.configure();case 2:return n=e.sent,i=n.cram,e.next=6,Promise.all(t.map((function(e){var t=e.refName,r=e.start,n=e.end,a=u.refNameToId(t);return i.index.getEntriesForRange(a,r,n)})));case 6:return s=e.sent,e.abrupt("return",s.flat().reduce((function(e,t){return e+t.sliceBytes}),0));case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}()}]),r}(d.BaseFeatureDataAdapter)},4978:function(){}}]);
//# sourceMappingURL=6849.43f88cba.chunk.js.map